<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZeroDay Feed</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

<style>
/* Reset and Base */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
  color: #fff;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Fullscreen Media Modal */
.media-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  z-index: 2000;
  justify-content: center;
  align-items: center;
}

.media-modal.active {
  display: flex;
}

.media-modal-content {
  max-width: 95%;
  max-height: 95%;
  position: relative;
}

.media-modal-content img,
.media-modal-content video {
  max-width: 100%;
  max-height: 95vh;
  object-fit: contain;
  border-radius: 8px;
}

.media-modal-close {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(255, 221, 0, 0.7);
  color: black;
  border: 2px solid #ffdd00;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-weight: bold;
}

.media-modal-close:hover {
  background: rgba(255, 221, 0, 0.9);
  transform: scale(1.1);
  box-shadow: 0 0 15px rgba(255, 221, 0, 0.8);
}

.media-modal-download {
  position: absolute;
  top: 20px;
  left: 20px;
  background: rgba(255, 221, 0, 0.7);
  color: black;
  border: 2px solid #ffdd00;
  padding: 10px 20px;
  border-radius: 25px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: bold;
}

.media-modal-download:hover {
  background: rgba(255, 221, 0, 0.9);
  transform: scale(1.05);
  box-shadow: 0 0 10px rgba(255, 221, 0, 0.7);
}

/* Scrollbar Styling (Desktop) */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(30, 30, 30, 0.5);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(45deg, #ffdd00, #ffaa00);
  border-radius: 10px;
  border: 1px solid #333;
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(45deg, #ffaa00, #ffdd00);
}

/* Container */
.container {
  max-width: 100%;
  margin: 0 auto;
  padding: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* NAVBAR WITH CUSTOM BACKGROUND */
.navbar {
  color: white;
  padding: 12px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 15px;
  position: sticky;
  top: 0;
  z-index: 1000;
  background-image: url('https://i.postimg.cc/mDp9RdK6/zeroday.jpg');
  background-size: cover;
  background-position: center;
  border-bottom: 2px solid #ffdd00;
  box-shadow: 0 4px 20px rgba(255, 221, 0, 0.4);
  min-height: 70px;
}

.navbar-left, .navbar-right {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.navbar button {
  cursor: pointer;
  padding: 8px 16px;
  border: 2px solid #ffdd00;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  background: rgba(30, 30, 30, 0.85);
  color: #ffdd00;
  text-shadow: 0 0 5px rgba(255, 221, 0, 0.5);
}

.navbar button:hover {
  background: rgba(255, 221, 0, 0.2);
  transform: translateY(-2px);
  box-shadow: 0 0 10px rgba(255, 221, 0, 0.7);
}

#userEmail {
  font-weight: bold;
  padding: 8px 15px;
  background: rgba(30, 30, 30, 0.85);
  border-radius: 20px;
  border: 2px solid #ffdd00;
  color: #ffdd00;
  text-shadow: 0 0 5px rgba(255, 221, 0, 0.5);
}

/* TIKTOK-STYLE FEED CONTAINER */
#tiktokFeed {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 70px);
  overflow-y: auto;
  scroll-snap-type: y mandatory;
  scroll-behavior: smooth;
  position: relative;
}

.tiktok-post {
  flex: 0 0 100%;
  min-height: 100vh;
  scroll-snap-align: start;
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  padding: 20px;
  background: rgba(20, 20, 20, 0.95);
  border-bottom: 1px solid rgba(255, 221, 0, 0.3);
}

.tiktok-media-container {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #000;
  z-index: 1;
}

.tiktok-media-container img,
.tiktok-media-container video {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

.tiktok-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.tiktok-content {
  position: relative;
  z-index: 2;
  background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
  padding: 20px;
  border-radius: 10px;
  border: 2px solid #ffdd00;
  box-shadow: 0 0 20px rgba(255, 221, 0, 0.5);
  margin-bottom: 80px;
}

.tiktok-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(255, 221, 0, 0.5);
}

.tiktok-user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.tiktok-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: 2px solid #ffdd00;
  object-fit: cover;
  box-shadow: 0 0 10px rgba(255, 221, 0, 0.7);
}

.tiktok-username {
  font-weight: bold;
  color: #ffdd00;
  font-size: 18px;
  text-shadow: 0 0 10px rgba(255, 221, 0, 0.7);
}

.tiktok-time {
  font-size: 12px;
  color: #ffdd99;
}

.tiktok-title {
  font-size: 20px;
  font-weight: bold;
  color: #fff;
  margin-bottom: 15px;
  text-shadow: 0 0 5px rgba(255, 221, 0, 0.5);
}

.tiktok-tag {
  padding: 6px 15px;
  font-size: 13px;
  border-radius: 20px;
  display: inline-block;
  background: linear-gradient(45deg, #ffdd00, #ffaa00);
  color: #000;
  font-weight: bold;
  border: 2px solid #ffdd00;
  box-shadow: 0 0 10px rgba(255, 221, 0, 0.7);
}

.tiktok-tag.andre-tag {
  background: linear-gradient(45deg, #ff0000, #ff8800);
  color: #fff;
  animation: pulseGlow 2s infinite;
}

@keyframes pulseGlow {
  0%, 100% { 
    box-shadow: 0 0 10px rgba(255, 221, 0, 0.7);
    transform: scale(1);
  }
  50% { 
    box-shadow: 0 0 20px rgba(255, 221, 0, 0.9);
    transform: scale(1.05);
  }
}

.tiktok-controls {
  position: absolute;
  right: 20px;
  bottom: 100px;
  display: flex;
  flex-direction: column;
  gap: 15px;
  z-index: 3;
}

.control-btn {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: 2px solid #ffdd00;
  background: rgba(30, 30, 30, 0.8);
  color: #ffdd00;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 0 10px rgba(255, 221, 0, 0.5);
}

.control-btn:hover {
  background: rgba(255, 221, 0, 0.2);
  transform: scale(1.1);
  box-shadow: 0 0 15px rgba(255, 221, 0, 0.8);
}

/* Profile Section */
.profile-section {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(30, 30, 30, 0.9);
  border-radius: 10px;
  border: 2px solid #ffdd00;
  box-shadow: 0 0 15px rgba(255, 221, 0, 0.4);
}

.profile-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 3px solid #ffdd00;
  object-fit: cover;
  box-shadow: 0 0 15px rgba(255, 221, 0, 0.7);
}

.profile-info {
  flex: 1;
}

.profile-username {
  font-size: 24px;
  font-weight: bold;
  color: #ffdd00;
  margin-bottom: 5px;
  text-shadow: 0 0 10px rgba(255, 221, 0, 0.7);
}

.profile-bio {
  color: #ffdd99;
  font-size: 14px;
  margin-bottom: 10px;
}

.profile-stats {
  display: flex;
  gap: 20px;
  font-size: 12px;
  color: #ffdd99;
}

.stat {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.stat-value {
  font-weight: bold;
  font-size: 16px;
  color: #ffdd00;
}

/* Profile Customization Modal */
.profile-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  z-index: 3000;
  justify-content: center;
  align-items: center;
}

.profile-modal.active {
  display: flex;
}

.profile-modal-content {
  background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
  border: 3px solid #ffdd00;
  border-radius: 15px;
  padding: 30px;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 0 30px rgba(255, 221, 0, 0.7);
}

.profile-modal-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: rgba(255, 221, 0, 0.7);
  color: black;
  border: 2px solid #ffdd00;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.profile-modal-close:hover {
  background: rgba(255, 221, 0, 0.9);
  box-shadow: 0 0 10px rgba(255, 221, 0, 0.8);
}

/* Color Picker */
.color-picker {
  display: flex;
  gap: 10px;
  margin: 15px 0;
  flex-wrap: wrap;
}

.color-option {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all 0.3s ease;
}

.color-option:hover {
  transform: scale(1.2);
}

.color-option.selected {
  border-color: white;
  box-shadow: 0 0 10px rgba(255, 221, 0, 0.7);
}

/* Pages */
.page {
  display: none;
  padding: 0;
  margin-top: 0;
  min-height: calc(100vh - 70px);
}

#login, #signup {
  max-width: 400px;
  margin: 40px auto;
  padding: 20px;
}

/* Form Elements */
input, textarea, select, button:not(.navbar button, .control-btn) {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  font-size: 16px;
  background: rgba(30, 30, 30, 0.9);
  border: 2px solid #ffdd00;
  border-radius: 5px;
  color: #fff;
}

button:not(.navbar button, .control-btn) {
  background: linear-gradient(45deg, #ffdd00, #ffaa00);
  color: #000;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  font-weight: bold;
}

button:not(.navbar button, .control-btn):hover {
  background: linear-gradient(45deg, #ffaa00, #ffdd00);
  transform: translateY(-2px);
  box-shadow: 0 0 15px rgba(255, 221, 0, 0.7);
}

a {
  color: #ffdd00;
  text-decoration: none;
  font-weight: 600;
}

a:hover {
  text-decoration: underline;
  color: #ffaa00;
}

/* CREATE POST PAGE */
#post {
  padding: 20px;
}

#post h2 {
  color: #ffdd00;
  text-shadow: 0 0 10px rgba(255, 221, 0, 0.7);
  margin-bottom: 20px;
  border-bottom: 2px solid #ffdd00;
  padding-bottom: 10px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .container {
    padding: 0;
  }
  
  .navbar {
    flex-direction: column;
    padding: 10px;
    min-height: 60px;
  }
  
  .navbar-left, .navbar-right {
    width: 100%;
    justify-content: center;
  }
  
  #tiktokFeed {
    height: calc(100vh - 60px);
  }
  
  .tiktok-controls {
    right: 10px;
    bottom: 80px;
  }
  
  .control-btn {
    width: 40px;
    height: 40px;
    font-size: 16px;
  }
  
  .tiktok-content {
    margin-bottom: 60px;
    padding: 15px;
  }
  
  .profile-section {
    flex-direction: column;
    text-align: center;
  }
  
  .profile-stats {
    justify-content: center;
  }
}

@media (max-width: 480px) {
  .navbar button {
    padding: 6px 12px;
    font-size: 12px;
  }
  
  #userEmail {
    font-size: 14px;
    text-align: center;
    margin-bottom: 10px;
  }
  
  input, button:not(.navbar button, .control-btn) {
    padding: 10px;
    font-size: 14px;
  }
  
  .color-picker {
    justify-content: center;
  }
}

/* Loading Animation */
@keyframes loading {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading {
  border: 4px solid rgba(255, 221, 0, 0.3);
  border-radius: 50%;
  border-top: 4px solid #ffdd00;
  width: 40px;
  height: 40px;
  animation: loading 1s linear infinite;
  margin: 20px auto;
}

/* File Input Customization */
.custom-file-input {
  position: relative;
  overflow: hidden;
  display: inline-block;
  width: 100%;
}

.custom-file-input input[type="file"] {
  position: absolute;
  left: 0;
  top: 0;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

.file-input-label {
  display: block;
  padding: 12px;
  background: rgba(30, 30, 30, 0.9);
  border: 2px dashed #ffdd00;
  border-radius: 5px;
  text-align: center;
  color: #ffdd99;
  cursor: pointer;
  transition: all 0.3s ease;
}

.file-input-label:hover {
  background: rgba(30, 30, 30, 0.95);
  border-color: #ffaa00;
}

.file-input-label.dragover {
  background: rgba(255, 221, 0, 0.1);
  border-color: #ffdd00;
}

/* Status Message */
.status-message {
  padding: 10px;
  margin: 10px 0;
  border-radius: 5px;
  text-align: center;
  font-size: 14px;
  display: none;
}

.status-message.success {
  background: rgba(0, 255, 0, 0.1);
  border: 1px solid #00ff00;
  color: #00ff00;
  display: block;
}

.status-message.error {
  background: rgba(255, 0, 0, 0.1);
  border: 1px solid #ff0000;
  color: #ff0000;
  display: block;
}

.status-message.info {
  background: rgba(255, 221, 0, 0.1);
  border: 1px solid #ffdd00;
  color: #ffdd00;
  display: block;
}
</style>
</head>
<body class="yellow-glow-theme">

<!-- Fullscreen Media Modal -->
<div id="mediaModal" class="media-modal">
  <div class="media-modal-content">
    <button class="media-modal-close" onclick="closeMediaModal()">‚úï</button>
    <button class="media-modal-download" onclick="downloadMedia()">Download</button>
    <div id="modalMediaContainer"></div>
  </div>
</div>

<!-- Profile Customization Modal -->
<div id="profileModal" class="profile-modal">
  <div class="profile-modal-content">
    <button class="profile-modal-close" onclick="closeProfileModal()">‚úï</button>
    <h2 style="color: #ffdd00; text-shadow: 0 0 10px rgba(255,221,0,0.7);">Edit Profile</h2>
    
    <div class="profile-form">
      <!-- Status Messages -->
      <div id="profileStatus" class="status-message"></div>
      
      <!-- Fixed Profile Photo Display -->
      <div style="text-align: center; margin: 20px 0;">
        <img src="https://static.vecteezy.com/system/resources/thumbnails/009/292/244/small/default-avatar-icon-of-social-media-user-vector.jpg" 
             alt="Profile Photo" 
             style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid #ffdd00; object-fit: cover; margin: 0 auto; display: block;">
        <p style="color: #ffdd99; font-size: 12px; margin-top: 10px;">Default profile photo - Cannot be changed</p>
      </div>
      
      <label style="color: #ffdd00; display: block; margin-top: 15px;">Username:</label>
      <input type="text" id="profileUsername" placeholder="Enter username">
      
      <label style="color: #ffdd00; display: block; margin-top: 15px;">Bio:</label>
      <textarea id="profileBio" placeholder="Tell us about yourself..." rows="3"></textarea>
      
      <label style="color: #ffdd00; display: block; margin-top: 15px;">Theme Color:</label>
      <div class="color-picker">
        <div class="color-option" style="background: #ffdd00;" onclick="selectColor('#ffdd00')"></div>
        <div class="color-option" style="background: #ffaa00;" onclick="selectColor('#ffaa00')"></div>
        <div class="color-option" style="background: #ff8800;" onclick="selectColor('#ff8800')"></div>
        <div class="color-option" style="background: #ffff00;" onclick="selectColor('#ffff00')"></div>
        <div class="color-option" style="background: #ffcc00;" onclick="selectColor('#ffcc00')"></div>
      </div>
      
      <button onclick="saveProfile()" style="margin-top: 20px;" id="saveProfileBtn">Save Profile</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="navbar">
    <div class="navbar-left">
      <span id="userEmail">Not signed in</span>
      <button id="logoutBtn" onclick="logout()">Logout</button>
    </div>
    <div class="navbar-right">
      <button onclick="show('home')">Home</button>
      <button onclick="show('post')">Post</button>
      <button onclick="show('profile')" id="profileBtn" style="display: none;">My Profile</button>
    </div>
  </div>

  <!-- PROFILE PAGE -->
  <div id="profile" class="page" style="padding: 20px;">
    <div id="profileDisplay">
      <div class="loading"></div>
    </div>
    <button onclick="openProfileModal()" style="width: auto; align-self: flex-start; margin-top: 20px;">Edit Profile</button>
  </div>

  <!-- LOGIN PAGE -->
  <div id="login" class="page">
    <h2 style="color: #ffdd00; text-shadow: 0 0 10px rgba(255,221,0,0.7);">Login</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPass" placeholder="Password">
    <button onclick="login()">Login</button>
    <p>No account? <a href="#" onclick="show('signup')">Sign Up</a></p>
  </div>

  <!-- SIGNUP PAGE -->
  <div id="signup" class="page">
    <h2 style="color: #ffdd00; text-shadow: 0 0 10px rgba(255,221,0,0.7);">Sign Up</h2>
    <input type="email" id="signupEmail" placeholder="Email">
    <input type="password" id="signupPass" placeholder="Password">
    <input type="text" id="signupUsername" placeholder="Username (optional)">
    <button onclick="signup()">Sign Up</button>
    <p>Already have account? <a href="#" onclick="show('login')">Login</a></p>
  </div>

  <!-- TIKTOK-STYLE HOME FEED -->
  <div id="home" class="page" style="padding: 0; overflow: hidden;">
    <div id="tiktokFeed">
      <!-- Posts will be loaded here -->
      <div class="loading"></div>
    </div>
  </div>

  <!-- CREATE POST -->
  <div id="post" class="page">
    <h2>Create Post</h2>
    <input id="title" placeholder="Title">
    <div class="custom-file-input">
      <input type="file" id="file" accept="image/*,video/*">
      <label class="file-input-label" for="file">üìÅ Choose file or drag and drop</label>
    </div>
    <button onclick="publish()">Publish</button>
  </div>
</div>

<script>
// FIREBASE INIT
firebase.initializeApp({
  apiKey: "AIzaSyDZYK8wRGXJNlGYNosolSo2zeEjLrqd4Eg",
  authDomain: "pastebin-604ee.firebaseapp.com",
  projectId: "pastebin-604ee",
  storageBucket: "pastebin-604ee.appspot.com"
});

const auth = firebase.auth();
const db = firebase.firestore();

// Global variables
let currentMediaUrl = '';
let currentMediaType = '';
let currentVideoIndex = 0;
let selectedColor = '#ffdd00';

// Fixed default avatar
const DEFAULT_AVATAR = 'https://static.vecteezy.com/system/resources/thumbnails/009/292/244/small/default-avatar-icon-of-social-media-user-vector.jpg';

// User profile data
let userProfile = {
  username: '',
  bio: '',
  avatar: DEFAULT_AVATAR,
  themeColor: '#ffdd00',
  postCount: 0,
  joinDate: ''
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
  show('login');
});

// Show status message
function showStatus(message, type = 'info') {
  const statusDiv = document.getElementById('profileStatus');
  statusDiv.textContent = message;
  statusDiv.className = 'status-message ' + type;
  statusDiv.style.display = 'block';
  
  if (type === 'success') {
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 3000);
  }
}

// PROFILE MODAL FUNCTIONS
function openProfileModal() {
  const modal = document.getElementById('profileModal');
  const user = auth.currentUser;
  
  if (!user) {
    showStatus('Please login to edit your profile', 'error');
    return;
  }
  
  showStatus('Loading profile...', 'info');
  
  // Load current profile data
  loadUserProfile(user.uid).then(profile => {
    document.getElementById('profileUsername').value = profile.username || user.email.split('@')[0];
    document.getElementById('profileBio').value = profile.bio || '';
    
    // Set selected color
    selectedColor = profile.themeColor || '#ffdd00';
    
    // Update color picker
    document.querySelectorAll('.color-option').forEach(option => {
      option.classList.remove('selected');
      if (option.style.backgroundColor === selectedColor) {
        option.classList.add('selected');
      }
    });
    
    // Enable save button
    const saveBtn = document.getElementById('saveProfileBtn');
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Profile';
    
    showStatus('Profile loaded. Make your changes and click Save.', 'info');
  }).catch(error => {
    showStatus('Error loading profile: ' + error.message, 'error');
  });
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeProfileModal() {
  const modal = document.getElementById('profileModal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
  
  // Clear status message
  const statusDiv = document.getElementById('profileStatus');
  statusDiv.style.display = 'none';
}

function selectColor(color) {
  selectedColor = color;
  
  // Update selection
  document.querySelectorAll('.color-option').forEach(option => {
    option.classList.remove('selected');
    if (option.style.backgroundColor === color) {
      option.classList.add('selected');
    }
  });
}

// Save profile function - SIMPLIFIED VERSION
async function saveProfile() {
  const user = auth.currentUser;
  if (!user) {
    showStatus('Please login to save your profile', 'error');
    return;
  }
  
  const username = document.getElementById('profileUsername').value.trim();
  const bio = document.getElementById('profileBio').value.trim();
  
  const saveBtn = document.getElementById('saveProfileBtn');
  
  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';
  showStatus('Saving profile...', 'info');
  
  try {
    // Validate username
    if (!username) {
      showStatus('Username is required', 'error');
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Profile';
      return;
    }
    
    // Update user profile in Firestore
    const profileData = {
      username: username,
      bio: bio,
      avatar: DEFAULT_AVATAR, // Always use the fixed default avatar
      themeColor: selectedColor,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    await db.collection('profiles').doc(user.uid).set(profileData, { merge: true });
    
    // Update local profile
    userProfile.username = profileData.username;
    userProfile.bio = profileData.bio;
    userProfile.avatar = DEFAULT_AVATAR;
    userProfile.themeColor = profileData.themeColor;
    
    // Update UI
    updateProfileDisplay();
    
    // Update posts with new username
    updateUserPosts(profileData.username);
    
    showStatus('Profile saved successfully!', 'success');
    
    // Close modal after success
    setTimeout(() => {
      closeProfileModal();
    }, 1500);
    
  } catch (error) {
    console.error('Error saving profile:', error);
    showStatus('Error saving profile: ' + error.message, 'error');
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Profile';
  }
}

// Update all user's posts with new username
async function updateUserPosts(username) {
  try {
    const user = auth.currentUser;
    if (!user) return;
    
    const postsQuery = await db.collection('posts')
      .where('author', '==', user.email)
      .get();
    
    if (postsQuery.size > 0) {
      const batch = db.batch();
      
      postsQuery.forEach(doc => {
        const postRef = db.collection('posts').doc(doc.id);
        batch.update(postRef, {
          authorUsername: username
        });
      });
      
      await batch.commit();
      console.log(`Updated ${postsQuery.size} posts with new username`);
    }
  } catch (error) {
    console.error('Error updating posts:', error);
  }
}

// Load user profile from Firestore
async function loadUserProfile(uid) {
  try {
    const doc = await db.collection('profiles').doc(uid).get();
    
    if (doc.exists) {
      const data = doc.data();
      userProfile = {
        username: data.username || auth.currentUser.email.split('@')[0],
        bio: data.bio || '',
        avatar: DEFAULT_AVATAR, // Always use fixed default avatar
        themeColor: data.themeColor || '#ffdd00',
        joinDate: data.joinDate || new Date().toLocaleDateString(),
        postCount: data.postCount || 0
      };
    } else {
      // Create default profile
      const user = auth.currentUser;
      userProfile = {
        username: user.email.split('@')[0],
        bio: '',
        avatar: DEFAULT_AVATAR,
        themeColor: '#ffdd00',
        joinDate: new Date().toLocaleDateString(),
        postCount: 0
      };
      
      // Save to Firestore
      await db.collection('profiles').doc(uid).set({
        ...userProfile,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    // Load actual post count
    const posts = await db.collection('posts')
      .where('author', '==', auth.currentUser.email)
      .get();
    userProfile.postCount = posts.size;
    
    // Update post count in profile
    await db.collection('profiles').doc(uid).update({
      postCount: userProfile.postCount
    });
    
    return userProfile;
  } catch (error) {
    console.error('Error loading profile:', error);
    // Return basic profile even on error
    const user = auth.currentUser;
    return {
      username: user.email.split('@')[0],
      bio: '',
      avatar: DEFAULT_AVATAR,
      themeColor: '#ffdd00',
      joinDate: new Date().toLocaleDateString(),
      postCount: 0
    };
  }
}

// Update profile display
function updateProfileDisplay() {
  const user = auth.currentUser;
  if (!user) return;
  
  const profileDisplay = document.getElementById('profileDisplay');
  
  // Ensure we have valid data
  const displayUsername = userProfile.username || user.email.split('@')[0];
  const displayBio = userProfile.bio || 'No bio yet. Click Edit Profile to add one!';
  const displayPostCount = userProfile.postCount || 0;
  const displayJoinDate = userProfile.joinDate || new Date().toLocaleDateString();
  
  profileDisplay.innerHTML = `
    <div class="profile-section">
      <img src="${DEFAULT_AVATAR}" alt="Avatar" class="profile-avatar">
      <div class="profile-info">
        <div class="profile-username">${displayUsername}</div>
        <div class="profile-email" style="color: #ffaa00; font-size: 12px; margin-bottom: 10px;">${user.email}</div>
        <div class="profile-bio">${displayBio}</div>
        <div class="profile-stats">
          <div class="stat">
            <span class="stat-value">${displayPostCount}</span>
            <span>Posts</span>
          </div>
          <div class="stat">
            <span class="stat-value">${displayJoinDate}</span>
            <span>Joined</span>
          </div>
        </div>
      </div>
    </div>
  `;
}

// MEDIA MODAL FUNCTIONS
function openMediaModal(mediaUrl, mediaType) {
  currentMediaUrl = mediaUrl;
  currentMediaType = mediaType;
  
  const modal = document.getElementById('mediaModal');
  const container = document.getElementById('modalMediaContainer');
  
  container.innerHTML = '';
  
  if (mediaType.startsWith('image')) {
    const img = document.createElement('img');
    img.src = mediaUrl;
    img.alt = 'Full preview';
    container.appendChild(img);
  } else if (mediaType.startsWith('video')) {
    const video = document.createElement('video');
    video.src = mediaUrl;
    video.controls = true;
    video.autoplay = true;
    container.appendChild(video);
  }
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeMediaModal() {
  const modal = document.getElementById('mediaModal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
  
  const video = modal.querySelector('video');
  if (video) {
    video.pause();
  }
}

function downloadMedia() {
  if (!currentMediaUrl) return;
  
  const link = document.createElement('a');
  link.href = currentMediaUrl;
  link.download = `media_${new Date().getTime()}`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// TIKTOK FEED FUNCTIONS
function setupTikTokScroll() {
  const feed = document.getElementById('tiktokFeed');
  
  feed.addEventListener('scroll', handleScroll);
  setTimeout(handleScroll, 1000);
}

function handleScroll() {
  const feed = document.getElementById('tiktokFeed');
  const posts = feed.querySelectorAll('.tiktok-post');
  
  let mostVisiblePost = null;
  let maxVisibility = 0;
  
  posts.forEach((post, index) => {
    const rect = post.getBoundingClientRect();
    const visibleHeight = Math.min(rect.bottom, window.innerHeight) - Math.max(rect.top, 0);
    const visibilityRatio = visibleHeight / Math.min(rect.height, window.innerHeight);
    
    if (visibilityRatio > maxVisibility) {
      maxVisibility = visibilityRatio;
      mostVisiblePost = { element: post, index };
    }
  });
  
  if (mostVisiblePost && mostVisiblePost.index !== currentVideoIndex) {
    const video = mostVisiblePost.element.querySelector('video');
    if (video) {
      const currentVideo = feed.querySelectorAll('video')[currentVideoIndex];
      if (currentVideo) {
        currentVideo.pause();
      }
      
      video.play().catch(e => console.log('Autoplay prevented:', e));
      currentVideoIndex = mostVisiblePost.index;
    }
  }
}

// Load TikTok-style posts
async function loadTikTokPosts() {
  const feedContainer = document.getElementById('tiktokFeed');
  feedContainer.innerHTML = '<div class="loading"></div>';
  
  db.collection("posts").orderBy("time","desc").onSnapshot(async s=>{
    if(s.empty){
      feedContainer.innerHTML='<div class="tiktok-post" style="display: flex; align-items: center; justify-content: center; color: #ffdd99; font-size: 18px;">No posts yet. Be the first to post!</div>';
      return;
    }
    
    feedContainer.innerHTML="";
    
    const posts = [];
    s.forEach(d => posts.push({ id: d.id, data: d.data() }));
    
    posts.forEach((postData, index) => {
      const p = postData.data;
      const postDiv = document.createElement("div");
      postDiv.className = 'tiktok-post';
      
      const time = p.time ? new Date(p.time.seconds * 1000).toLocaleString() : 'Just now';
      const isAndre = p.author === 'exoticslash3r@gmail.com';
      const tagClass = isAndre ? 'tiktok-tag andre-tag' : 'tiktok-tag';
      const tagText = isAndre ? 'AndreKriegman' : (p.authorUsername || p.author.split('@')[0]);
      const avatar = DEFAULT_AVATAR; // Always use the fixed default avatar
      
      postDiv.innerHTML = `
        <div class="tiktok-media-container">
          ${p.type.startsWith("image") ? 
            `<img src="${p.media}" alt="${p.title}" class="tiktok-media">` : 
            `<video src="${p.media}" class="tiktok-video" loop muted playsinline></video>`
          }
        </div>
        
        <div class="tiktok-content">
          <div class="tiktok-header">
            <div class="tiktok-user-info">
              <img src="${avatar}" alt="Avatar" class="tiktok-avatar">
              <div>
                <div class="tiktok-username">${p.authorUsername || p.author.split('@')[0]}</div>
                <div class="tiktok-time">${time}</div>
              </div>
            </div>
            <span class="${tagClass}">${tagText}</span>
          </div>
          <div class="tiktok-title">${p.title}</div>
        </div>
        
        <div class="tiktok-controls">
          <button class="control-btn" onclick="likePost('${postData.id}')">‚ù§Ô∏è</button>
          <button class="control-btn" onclick="openMediaModal('${p.media}', '${p.type}')">üîç</button>
          <button class="control-btn" onclick="sharePost('${postData.id}')">‚ÜóÔ∏è</button>
        </div>
      `;
      
      const currentUser = auth.currentUser;
      if (currentUser && (currentUser.email === p.author || currentUser.email === 'exoticslash3r@gmail.com')) {
        const del = document.createElement('button');
        del.textContent = 'Delete';
        del.className = 'delete';
        del.style.position = 'absolute';
        del.style.top = '20px';
        del.style.right = '20px';
        del.style.zIndex = '10';
        del.onclick = (e) => {
          e.stopPropagation();
          if (confirm('Delete this post?')) {
            db.collection('posts').doc(postData.id).delete();
          }
        };
        postDiv.appendChild(del);
      }
      
      feedContainer.appendChild(postDiv);
    });
    
    setTimeout(() => {
      setupTikTokScroll();
      const firstVideo = feedContainer.querySelector('video');
      if (firstVideo) {
        firstVideo.play().catch(e => console.log('Autoplay prevented:', e));
      }
    }, 500);
  }, error => {
    feedContainer.innerHTML='<div class="tiktok-post" style="display: flex; align-items: center; justify-content: center; color: #ff6666; font-size: 18px;">Error loading posts. Please try again.</div>';
    console.error('Error loading posts:', error);
  });
}

// Post interaction functions
function likePost(postId) {
  const user = auth.currentUser;
  if (!user) {
    alert('Please login to like posts');
    return;
  }
  
  db.collection('likes').add({
    postId: postId,
    userId: user.uid,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    console.log('Post liked');
  }).catch(error => {
    console.error('Error liking post:', error);
  });
}

function sharePost(postId) {
  const postUrl = `${window.location.origin}?post=${postId}`;
  navigator.clipboard.writeText(postUrl).then(() => {
    alert('Post link copied to clipboard!');
  }).catch(err => {
    prompt('Copy this link:', postUrl);
  });
}

// SHOW PAGE FUNCTION
function show(id){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.getElementById(id).style.display='block';
  
  if (id === 'home') {
    loadTikTokPosts();
  } else if (id === 'profile') {
    updateProfileDisplay();
  }
}

// AUTH STATE
auth.onAuthStateChanged(async user=>{
  if(user){
    document.getElementById('userEmail').textContent = user.email + (user.email === 'exoticslash3r@gmail.com' ? ' (AndreKriegman)' : '');
    document.getElementById('logoutBtn').style.display='inline-block';
    document.getElementById('profileBtn').style.display='inline-block';
    
    // Load user profile
    await loadUserProfile(user.uid);
    
    show('home');
    loadTikTokPosts();
  } else {
    document.getElementById('userEmail').textContent='Not signed in';
    document.getElementById('logoutBtn').style.display='none';
    document.getElementById('profileBtn').style.display='none';
    show('login');
  }
});

// SIGNUP / LOGIN
async function signup(){
  const email = document.getElementById('signupEmail').value;
  const pass = document.getElementById('signupPass').value;
  const username = document.getElementById('signupUsername').value.trim();
  
  if (!email || !pass) {
    alert('Email and password are required');
    return;
  }
  
  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
    const user = userCredential.user;
    
    // Create profile for new user
    await db.collection('profiles').doc(user.uid).set({
      username: username || email.split('@')[0],
      bio: '',
      avatar: DEFAULT_AVATAR,
      themeColor: '#ffdd00',
      joinDate: new Date().toLocaleDateString(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    alert('Account created successfully!');
    show('home');
  } catch(e) {
    alert('Error: ' + e.message);
  }
}

function login(){
  const email=document.getElementById('loginEmail').value;
  const pass=document.getElementById('loginPass').value;
  
  if (!email || !pass) {
    alert('Email and password are required');
    return;
  }
  
  auth.signInWithEmailAndPassword(email,pass)
  .then(() => {
    alert('Logged in successfully!');
  })
  .catch(e=>alert('Error: ' + e.message));
}

function logout(){ 
  if(confirm("Are you sure you want to logout?")) {
    auth.signOut();
  }
}

// CREATE POST
function publish(){
  const user=auth.currentUser;
  if(!user) return alert("Login first");
  
  const t=document.getElementById('title').value.trim();
  const f=document.getElementById('file').files[0];
  
  if(!t) return alert("Title is required");
  if(!f) return alert("Please select a file");
  if(!f.type.startsWith("image/")&&!f.type.startsWith("video/")) return alert("Only images and videos are allowed");

  const publishBtn = document.querySelector('#post button');
  const originalText = publishBtn.textContent;
  publishBtn.textContent = 'Uploading...';
  publishBtn.disabled = true;

  const r=new FileReader();
  r.onload=()=>{
    // Always use default avatar and current profile username
    const authorUsername = userProfile.username || user.email.split('@')[0];
    
    db.collection("posts").add({
      title:t,
      media:r.result,
      type:f.type,
      author:user.email,
      authorUsername: authorUsername,
      authorAvatar: DEFAULT_AVATAR,
      time:firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      document.getElementById('title').value=""; 
      document.getElementById('file').value="";
      document.querySelector('.file-input-label').textContent = 'üìÅ Choose file or drag and drop';
      alert('Post published successfully!');
      show('home');
      
      // Update post count
      userProfile.postCount = (userProfile.postCount || 0) + 1;
      db.collection('profiles').doc(user.uid).update({
        postCount: userProfile.postCount
      });
    }).catch(e => {
      alert('Error: ' + e.message);
    }).finally(() => {
      publishBtn.textContent = originalText;
      publishBtn.disabled = false;
    });
  };
  r.readAsDataURL(f);
}

// Update file input label
document.getElementById('file').addEventListener('change', function(e) {
  const label = document.querySelector('.file-input-label');
  if (this.files.length > 0) {
    label.textContent = `üìÅ Selected: ${this.files[0].name}`;
  } else {
    label.textContent = 'üìÅ Choose file or drag and drop';
  }
});

// Close modals when clicking outside content
document.getElementById('mediaModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeMediaModal();
  }
});

document.getElementById('profileModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeProfileModal();
  }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeMediaModal();
    closeProfileModal();
  }
});
</script>

</body>
</html>
