<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Feed with Auth & Messaging</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

<style>
/* Reset and Base */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #8b0000 0%, #4a0000 100%);
  color: #fff;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Fullscreen Media Modal */
.media-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  z-index: 2000;
  justify-content: center;
  align-items: center;
}

.media-modal.active {
  display: flex;
}

.media-modal-content {
  max-width: 95%;
  max-height: 95%;
  position: relative;
}

.media-modal-content img,
.media-modal-content video {
  max-width: 100%;
  max-height: 95vh;
  object-fit: contain;
  border-radius: 8px;
}

.media-modal-close {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(255, 0, 0, 0.7);
  color: white;
  border: 2px solid #8b0000;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.media-modal-close:hover {
  background: rgba(255, 0, 0, 0.9);
  transform: scale(1.1);
}

.media-modal-download {
  position: absolute;
  top: 20px;
  left: 20px;
  background: rgba(255, 0, 0, 0.7);
  color: white;
  border: 2px solid #8b0000;
  padding: 10px 20px;
  border-radius: 25px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.media-modal-download:hover {
  background: rgba(255, 0, 0, 0.9);
  transform: scale(1.05);
}

.media-preview {
  cursor: pointer;
  transition: transform 0.3s ease, opacity 0.3s ease;
  border: 2px solid #8b0000;
  border-radius: 8px;
}

.media-preview:hover {
  transform: scale(1.02);
  opacity: 0.9;
  border-color: #ff0000;
}

/* Scrollbar Styling (Desktop) */
::-webkit-scrollbar {
  width: 12px;
}

::-webkit-scrollbar-track {
  background: rgba(139, 0, 0, 0.2);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(45deg, #8b0000, #ff0000);
  border-radius: 10px;
  border: 2px solid #4a0000;
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(45deg, #ff0000, #8b0000);
}

/* Container */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* THEME STYLES */
body.normal-theme {
  background: linear-gradient(135deg, #8b0000 0%, #4a0000 100%);
  color: #fff;
}

body.bloody-red-theme {
  background: linear-gradient(135deg, #8b0000 0%, #4a0000 100%);
  color: #fff;
  font-family: "Courier New", "Arial Black", Arial, sans-serif;
}

.bloody-red-theme .navbar {
  background: linear-gradient(45deg, #8b0000, #4a0000);
  border: 3px solid #ff0000;
  border-radius: 0 0 15px 15px;
  box-shadow: 0 4px 20px rgba(255, 0, 0, 0.3);
  position: relative;
  overflow: hidden;
}

.bloody-red-theme .navbar::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent, #ff0000, transparent);
  animation: bloodFlow 3s infinite;
}

@keyframes bloodFlow {
  0% { left: -100%; }
  100% { left: 100%; }
}

.bloody-red-theme .navbar button {
  background: linear-gradient(45deg, #8b0000, #ff0000);
  color: #fff;
  border: 2px solid #ff4444;
  font-weight: bold;
  text-shadow: 1px 1px 0 #000;
  position: relative;
  overflow: hidden;
}

.bloody-red-theme .navbar button:hover {
  background: linear-gradient(45deg, #ff0000, #8b0000);
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
}

.bloody-red-theme .page {
  background: rgba(74, 0, 0, 0.9);
  border: 3px solid #ff0000;
  border-radius: 15px;
  box-shadow: 0 0 25px rgba(255, 0, 0, 0.5);
  position: relative;
  overflow: hidden;
}

.bloody-red-theme .page::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.1"><path d="M0,50 Q25,25 50,50 T100,50" stroke="%23ff0000" fill="none"/></svg>');
  pointer-events: none;
}

.bloody-red-theme .post {
  background: linear-gradient(135deg, rgba(139, 0, 0, 0.8), rgba(74, 0, 0, 0.9));
  border: 2px solid #ff4444;
  border-radius: 10px;
  box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
  position: relative;
  overflow: hidden;
}

.bloody-red-theme .post::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent, #ff0000, transparent);
}

.bloody-red-theme .tag.andre-tag {
  background: linear-gradient(45deg, #ff0000, #8b0000);
  color: #fff;
  font-weight: bold;
  animation: bloodPulse 2s infinite;
  border: 2px solid #ff4444;
  text-shadow: 1px 1px 2px #000;
}

.bloody-red-theme .tag.regular-tag {
  background: linear-gradient(45deg, #8b0000, #4a0000);
  color: #fff;
  font-weight: bold;
  border: 2px solid #ff4444;
}

@keyframes bloodPulse {
  0%, 100% { 
    box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    transform: scale(1);
  }
  50% { 
    box-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
    transform: scale(1.05);
  }
}

.bloody-red-theme input, 
.bloody-red-theme textarea,
.bloody-red-theme select,
.bloody-red-theme button:not(.navbar button) {
  border: 2px solid #ff0000;
  border-radius: 5px;
  background: rgba(74, 0, 0, 0.8);
  color: #fff;
}

.bloody-red-theme input::placeholder,
.bloody-red-theme textarea::placeholder {
  color: #ff9999;
}

.bloody-red-theme h2 {
  background: linear-gradient(45deg, #ff0000, #8b0000);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  position: relative;
  display: inline-block;
}

.bloody-red-theme h2::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, transparent, #ff0000, transparent);
}

/* Normal Theme */
.normal-theme .navbar {
  background: linear-gradient(135deg, #8b0000 0%, #4a0000 100%);
  border-bottom: 2px solid #ff0000;
}

.normal-theme .navbar button {
  background: #8b0000;
  color: white;
  transition: all 0.3s ease;
}

.normal-theme .navbar button:hover {
  background: #ff0000;
  transform: translateY(-2px);
}

.normal-theme .page {
  background: rgba(74, 0, 0, 0.95);
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(255, 0, 0, 0.2);
  color: #fff;
}

.normal-theme .post {
  background: rgba(139, 0, 0, 0.8);
  border: 1px solid #ff4444;
  border-radius: 6px;
  transition: transform 0.2s;
}

.normal-theme .post:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
}

.normal-theme .tag.andre-tag {
  background: linear-gradient(45deg, #ff0000, #8b0000);
  color: white;
  font-weight: bold;
}

.normal-theme .tag.regular-tag {
  background: #8b0000;
  color: white;
}

/* Navbar */
.navbar {
  color: white;
  padding: 15px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 15px;
  position: sticky;
  top: 0;
  z-index: 1000;
}

.navbar-left, .navbar-right {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.navbar button {
  cursor: pointer;
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
}

.navbar button:hover {
  opacity: 0.9;
}

#themeToggle {
  background: linear-gradient(45deg, #8b0000, #ff0000);
  color: white;
  border: 2px solid #ff4444;
}

#userEmail {
  font-weight: bold;
  padding: 8px 15px;
  background: rgba(255, 0, 0, 0.3);
  border-radius: 20px;
  border: 1px solid #ff4444;
}

/* Notification Badge */
.notification-badge {
  background: #ff0000;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  position: absolute;
  top: -5px;
  right: -5px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* Profile Section */
.profile-section {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(139, 0, 0, 0.3);
  border-radius: 10px;
  border: 2px solid #ff4444;
}

.profile-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 3px solid #ff0000;
  object-fit: cover;
  cursor: pointer;
  transition: transform 0.3s ease;
}

.profile-avatar:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px rgba(255, 0, 0, 0.7);
}

.profile-info {
  flex: 1;
}

.profile-username {
  font-size: 24px;
  font-weight: bold;
  color: #fff;
  margin-bottom: 5px;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

.profile-bio {
  color: #ff9999;
  font-size: 14px;
  margin-bottom: 10px;
}

.profile-stats {
  display: flex;
  gap: 20px;
  font-size: 12px;
  color: #ffcccc;
}

.stat {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.stat-value {
  font-weight: bold;
  font-size: 16px;
  color: #fff;
}

/* Profile Customization Modal */
.profile-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 3000;
  justify-content: center;
  align-items: center;
}

.profile-modal.active {
  display: flex;
}

.profile-modal-content {
  background: linear-gradient(135deg, #8b0000 0%, #4a0000 100%);
  border: 3px solid #ff0000;
  border-radius: 15px;
  padding: 30px;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
}

.profile-modal-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: rgba(255, 0, 0, 0.7);
  color: white;
  border: 2px solid #8b0000;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.profile-modal-close:hover {
  background: rgba(255, 0, 0, 0.9);
}

.profile-avatar-preview {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 3px solid #ff0000;
  object-fit: cover;
  margin: 0 auto 20px;
  display: block;
}

.avatar-upload-area {
  text-align: center;
  margin: 15px 0;
  padding: 20px;
  border: 2px dashed #ff0000;
  border-radius: 10px;
  background: rgba(74, 0, 0, 0.5);
  cursor: pointer;
  transition: all 0.3s ease;
}

.avatar-upload-area:hover {
  background: rgba(74, 0, 0, 0.7);
  border-color: #ff4444;
}

.avatar-upload-area.dragover {
  background: rgba(255, 0, 0, 0.2);
  border-color: #ff6666;
}

.upload-icon {
  font-size: 40px;
  color: #ff6666;
  margin-bottom: 10px;
}

.upload-text {
  color: #ff9999;
  font-size: 14px;
}

.upload-text strong {
  color: #ff6666;
}

/* Avatar Selection */
.avatar-options {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin: 15px 0;
}

.avatar-option {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all 0.3s ease;
  object-fit: cover;
}

.avatar-option:hover {
  transform: scale(1.1);
  border-color: #ff0000;
}

.avatar-option.selected {
  border-color: #ff0000;
  box-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
}

/* Color Picker */
.color-picker {
  display: flex;
  gap: 10px;
  margin: 15px 0;
  flex-wrap: wrap;
}

.color-option {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all 0.3s ease;
}

.color-option:hover {
  transform: scale(1.2);
}

.color-option.selected {
  border-color: white;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
}

/* Avatar Upload Preview */
.avatar-preview-container {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto 20px;
}

.avatar-preview-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
  cursor: pointer;
}

.avatar-preview-container:hover .avatar-preview-overlay {
  opacity: 1;
}

.avatar-preview-overlay span {
  color: white;
  font-size: 12px;
  text-align: center;
  padding: 10px;
}

/* Upload Progress */
.upload-progress {
  width: 100%;
  height: 10px;
  background: rgba(74, 0, 0, 0.5);
  border-radius: 5px;
  margin: 10px 0;
  overflow: hidden;
  display: none;
}

.upload-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #8b0000, #ff0000);
  width: 0%;
  transition: width 0.3s ease;
}

/* Pages */
.page {
  display: none;
  padding: 25px;
  margin-top: 20px;
  min-height: calc(100vh - 100px);
}

#login, #signup {
  max-width: 400px;
  margin: 40px auto;
}

/* Form Elements */
input, textarea, select, button:not(.navbar button) {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  font-size: 16px;
  background: rgba(74, 0, 0, 0.8);
  border: 2px solid #ff0000;
  border-radius: 5px;
  color: white;
}

button:not(.navbar button) {
  background: linear-gradient(45deg, #8b0000, #ff0000);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.3s ease;
}

button:not(.navbar button):hover {
  background: linear-gradient(45deg, #ff0000, #8b0000);
  transform: translateY(-2px);
}

a {
  color: #ff6666;
  text-decoration: none;
  font-weight: 600;
}

a:hover {
  text-decoration: underline;
  color: #ff0000;
}

/* Posts */
#posts {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  padding: 20px;
  overflow-y: auto;
  max-height: calc(100vh - 200px);
}

.post {
  padding: 15px;
  position: relative;
  display: flex;
  flex-direction: column;
}

.post-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(255, 0, 0, 0.3);
}

.post-user-info {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
}

.post-user-info:hover .post-username {
  color: #ff6666;
}

.post-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid #ff0000;
  object-fit: cover;
}

.post-username {
  font-weight: bold;
  color: #fff;
  font-size: 16px;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
  transition: color 0.3s ease;
}

.post-time {
  font-size: 12px;
  color: #ff9999;
}

.post img, .post video {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin-top: 10px;
}

.post strong {
  font-size: 18px;
  margin-bottom: 5px;
  display: block;
  color: #fff;
}

.tag {
  padding: 5px 12px;
  font-size: 12px;
  border-radius: 15px;
  display: inline-block;
  margin-left: 10px;
}

/* Friend Actions */
.friend-actions {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 5px;
  z-index: 10;
}

.friend-btn {
  background: rgba(255, 0, 0, 0.7);
  color: white;
  border: 2px solid #8b0000;
  padding: 5px 10px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 12px;
  transition: all 0.3s ease;
}

.friend-btn:hover {
  background: rgba(255, 0, 0, 0.9);
  transform: scale(1.05);
}

.friend-btn.added {
  background: rgba(0, 128, 0, 0.7);
}

.friend-btn.pending {
  background: rgba(255, 165, 0, 0.7);
}

/* Delete Button */
.post button.delete {
  position: absolute;
  top: 10px;
  right: 80px;
  background: rgba(255, 0, 0, 0.7);
  color: white;
  border: 2px solid #8b0000;
  padding: 5px 10px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 12px;
  z-index: 10;
}

.post button.delete:hover {
  background: rgba(255, 0, 0, 0.9);
}

/* Messaging Page Styles */
#messaging {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.messaging-container {
  display: flex;
  gap: 20px;
  height: 600px;
}

/* Friends Sidebar */
.friends-sidebar {
  width: 300px;
  background: rgba(139, 0, 0, 0.3);
  border-radius: 10px;
  border: 2px solid #ff4444;
  padding: 15px;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.friends-search {
  display: flex;
  gap: 10px;
}

.friends-search input {
  flex: 1;
}

.friend-list {
  flex: 1;
  overflow-y: auto;
}

.friend-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s ease;
  margin-bottom: 5px;
}

.friend-item:hover {
  background: rgba(255, 0, 0, 0.2);
}

.friend-item.active {
  background: rgba(255, 0, 0, 0.3);
}

.friend-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid #ff0000;
  object-fit: cover;
}

.friend-info {
  flex: 1;
}

.friend-name {
  font-weight: bold;
  color: #fff;
}

.friend-status {
  font-size: 12px;
  color: #ff9999;
}

.friend-status.online {
  color: #00ff00;
}

.friend-status.offline {
  color: #ff6666;
}

/* Chat Container */
.chat-container {
  flex: 1;
  background: rgba(139, 0, 0, 0.3);
  border-radius: 10px;
  border: 2px solid #ff4444;
  display: flex;
  flex-direction: column;
}

.chat-header {
  padding: 15px;
  border-bottom: 1px solid rgba(255, 0, 0, 0.3);
  display: flex;
  align-items: center;
  gap: 10px;
}

.chat-header-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid #ff0000;
  object-fit: cover;
}

.chat-messages {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.message {
  max-width: 70%;
  padding: 10px 15px;
  border-radius: 15px;
  position: relative;
}

.message.sent {
  align-self: flex-end;
  background: linear-gradient(45deg, #8b0000, #ff0000);
  border-bottom-right-radius: 5px;
}

.message.received {
  align-self: flex-start;
  background: rgba(74, 0, 0, 0.8);
  border-bottom-left-radius: 5px;
  border: 1px solid #ff4444;
}

.message-time {
  font-size: 10px;
  color: #ff9999;
  margin-top: 5px;
  text-align: right;
}

.chat-input-area {
  padding: 15px;
  border-top: 1px solid rgba(255, 0, 0, 0.3);
  display: flex;
  gap: 10px;
}

.chat-input {
  flex: 1;
}

/* Friend Requests */
.requests-container {
  background: rgba(139, 0, 0, 0.3);
  border-radius: 10px;
  border: 2px solid #ff4444;
  padding: 20px;
}

.request-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  border-bottom: 1px solid rgba(255, 0, 0, 0.3);
}

.request-user {
  display: flex;
  align-items: center;
  gap: 10px;
}

.request-actions {
  display: flex;
  gap: 10px;
}

.request-btn {
  padding: 5px 15px;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  font-size: 12px;
  font-weight: bold;
}

.request-btn.accept {
  background: linear-gradient(45deg, #008000, #00ff00);
  color: white;
}

.request-btn.reject {
  background: linear-gradient(45deg, #8b0000, #ff0000);
  color: white;
}

/* Add Friend Section */
.add-friend-section {
  background: rgba(139, 0, 0, 0.3);
  border-radius: 10px;
  border: 2px solid #ff4444;
  padding: 20px;
  margin-bottom: 20px;
}

.add-friend-form {
  display: flex;
  gap: 10px;
}

/* Edit Post Button */
.edit-post-btn {
  position: absolute;
  top: 10px;
  right: 160px;
  background: rgba(255, 165, 0, 0.7);
  color: white;
  border: 2px solid #8b0000;
  padding: 5px 10px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 12px;
  z-index: 10;
}

.edit-post-btn:hover {
  background: rgba(255, 165, 0, 0.9);
}

/* Edit Post Modal */
.edit-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 4000;
  justify-content: center;
  align-items: center;
}

.edit-modal.active {
  display: flex;
}

.edit-modal-content {
  background: linear-gradient(135deg, #8b0000 0%, #4a0000 100%);
  border: 3px solid #ff0000;
  border-radius: 15px;
  padding: 30px;
  width: 90%;
  max-width: 500px;
  position: relative;
}

.edit-modal-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: rgba(255, 0, 0, 0.7);
  color: white;
  border: 2px solid #8b0000;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.edit-modal-close:hover {
  background: rgba(255, 0, 0, 0.9);
}

/* Responsive Design */
@media (max-width: 768px) {
  .container {
    padding: 10px;
  }
  
  .navbar {
    flex-direction: column;
    padding: 10px;
  }
  
  .navbar-left, .navbar-right {
    width: 100%;
    justify-content: center;
  }
  
  #posts {
    grid-template-columns: 1fr;
    padding: 10px;
    max-height: none;
    overflow-y: visible;
  }
  
  .page {
    padding: 15px;
    margin-top: 10px;
  }
  
  #themeToggle {
    order: -1;
    margin-bottom: 10px;
  }
  
  .media-modal-close {
    top: 10px;
    right: 10px;
    width: 35px;
    height: 35px;
  }
  
  .media-modal-download {
    top: 10px;
    left: 10px;
    padding: 8px 16px;
    font-size: 12px;
  }
  
  .profile-section {
    flex-direction: column;
    text-align: center;
  }
  
  .profile-stats {
    justify-content: center;
  }
  
  .avatar-options {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .profile-modal-content {
    padding: 20px;
  }
  
  .messaging-container {
    flex-direction: column;
    height: auto;
  }
  
  .friends-sidebar {
    width: 100%;
    height: 300px;
  }
  
  .chat-container {
    height: 400px;
  }
  
  .friend-actions {
    flex-direction: column;
    gap: 2px;
  }
  
  .post button.delete {
    right: 70px;
  }
  
  .edit-post-btn {
    right: 130px;
  }
}

@media (max-width: 480px) {
  .navbar button {
    padding: 6px 12px;
    font-size: 12px;
  }
  
  #userEmail {
    font-size: 14px;
    text-align: center;
    margin-bottom: 10px;
  }
  
  input, button:not(.navbar button) {
    padding: 10px;
    font-size: 14px;
  }
  
  .post {
    padding: 10px;
  }
  
  .avatar-options {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .color-picker {
    justify-content: center;
  }
  
  .add-friend-form {
    flex-direction: column;
  }
  
  .friend-actions {
    position: relative;
    top: 0;
    right: 0;
    margin-top: 10px;
    justify-content: flex-end;
  }
  
  .post button.delete {
    position: relative;
    top: 0;
    right: 0;
    margin-top: 10px;
    width: 100%;
  }
  
  .edit-post-btn {
    position: relative;
    top: 0;
    right: 0;
    margin-top: 10px;
    width: 100%;
  }
}

/* Loading Animation */
@keyframes loading {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading {
  border: 4px solid rgba(255, 0, 0, 0.3);
  border-radius: 50%;
  border-top: 4px solid #ff0000;
  width: 40px;
  height: 40px;
  animation: loading 1s linear infinite;
  margin: 20px auto;
}

/* File Input Customization */
.custom-file-input {
  position: relative;
  overflow: hidden;
  display: inline-block;
  width: 100%;
}

.custom-file-input input[type="file"] {
  position: absolute;
  left: 0;
  top: 0;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

.file-input-label {
  display: block;
  padding: 12px;
  background: rgba(74, 0, 0, 0.8);
  border: 2px dashed #ff0000;
  border-radius: 5px;
  text-align: center;
  color: #ff9999;
  cursor: pointer;
  transition: all 0.3s ease;
}

.file-input-label:hover {
  background: rgba(74, 0, 0, 0.9);
  border-color: #ff4444;
}

.file-input-label.dragover {
  background: rgba(255, 0, 0, 0.2);
  border-color: #ff6666;
}
</style>
</head>
<body class="bloody-red-theme">

<!-- Fullscreen Media Modal -->
<div id="mediaModal" class="media-modal">
  <div class="media-modal-content">
    <button class="media-modal-close" onclick="closeMediaModal()">‚úï</button>
    <button class="media-modal-download" onclick="downloadMedia()">Download</button>
    <div id="modalMediaContainer"></div>
  </div>
</div>

<!-- Profile Customization Modal -->
<div id="profileModal" class="profile-modal">
  <div class="profile-modal-content">
    <button class="profile-modal-close" onclick="closeProfileModal()">‚úï</button>
    <h2>Customize Profile</h2>
    
    <div class="profile-form">
      <!-- Avatar Preview with Upload Overlay -->
      <div class="avatar-preview-container">
        <img id="avatarPreview" class="profile-avatar-preview" src="" alt="Avatar Preview">
        <div class="avatar-preview-overlay" onclick="document.getElementById('avatarUpload').click()">
          <span>Click to<br>Upload Image</span>
        </div>
      </div>
      
      <!-- Hidden file input -->
      <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
      
      <!-- Upload Progress -->
      <div class="upload-progress" id="uploadProgress">
        <div class="upload-progress-bar" id="uploadProgressBar"></div>
      </div>
      
      <!-- Upload Area -->
      <div class="avatar-upload-area" id="avatarUploadArea" onclick="document.getElementById('avatarUpload').click()">
        <div class="upload-icon">üì∑</div>
        <div class="upload-text">
          <strong>Click to upload</strong> or drag and drop<br>
          <small>PNG, JPG, GIF up to 5MB</small>
        </div>
      </div>
      
      <label>Username:</label>
      <input type="text" id="profileUsername" placeholder="Enter username">
      
      <label>Bio:</label>
      <textarea id="profileBio" placeholder="Tell us about yourself..." rows="3"></textarea>
      
      <label>Theme Color:</label>
      <div class="color-picker">
        <div class="color-option" style="background: #8b0000;" onclick="selectColor('#8b0000')"></div>
        <div class="color-option" style="background: #ff0000;" onclick="selectColor('#ff0000')"></div>
        <div class="color-option" style="background: #4a0000;" onclick="selectColor('#4a0000')"></div>
        <div class="color-option" style="background: #660000;" onclick="selectColor('#660000')"></div>
        <div class="color-option" style="background: #cc0000;" onclick="selectColor('#cc0000')"></div>
      </div>
      
      <label>Or choose from default avatars:</label>
      <div class="avatar-options" id="avatarOptions">
        <!-- Avatars will be populated by JavaScript -->
      </div>
      
      <label>Custom Avatar URL (optional):</label>
      <input type="text" id="customAvatarUrl" placeholder="Or paste image URL here">
      
      <button onclick="saveProfile()" style="margin-top: 20px;" id="saveProfileBtn">Save Profile</button>
    </div>
  </div>
</div>

<!-- Edit Post Modal -->
<div id="editModal" class="edit-modal">
  <div class="edit-modal-content">
    <button class="edit-modal-close" onclick="closeEditModal()">‚úï</button>
    <h2>Edit Post</h2>
    
    <div class="edit-form">
      <label>Title:</label>
      <input type="text" id="editTitle" placeholder="Enter new title">
      
      <label>Change Media (optional):</label>
      <div class="custom-file-input">
        <input type="file" id="editFile" accept="image/*,video/*">
        <label class="file-input-label" for="editFile">üìÅ Choose new file (optional)</label>
      </div>
      
      <div id="currentMediaPreview" style="margin: 10px 0;"></div>
      
      <button onclick="updatePost()" style="margin-top: 20px;" id="updatePostBtn">Update Post</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="navbar">
    <div class="navbar-left">
      <span id="userEmail">Not signed in</span>
      <button id="logoutBtn" onclick="logout()">Logout</button>
    </div>
    <div class="navbar-right">
      <button id="themeToggle" onclick="toggleTheme()">Switch to Normal Theme</button>
      <button onclick="show('home')">Home</button>
      <button onclick="show('post')">Post</button>
      <button onclick="show('messaging')" id="messagingBtn" style="display: none;">
        Messages
        <span id="messageBadge" class="notification-badge" style="display: none;">0</span>
      </button>
      <button onclick="show('requests')" id="requestsBtn" style="display: none;">
        Requests
        <span id="requestBadge" class="notification-badge" style="display: none;">0</span>
      </button>
      <button onclick="show('profile')" id="profileBtn" style="display: none;">My Profile</button>
    </div>
  </div>

  <!-- PROFILE PAGE -->
  <div id="profile" class="page">
    <div id="profileDisplay"></div>
    <button onclick="openProfileModal()" style="width: auto; align-self: flex-start;">Edit Profile</button>
  </div>

  <!-- LOGIN PAGE -->
  <div id="login" class="page">
    <h2>Login</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPass" placeholder="Password">
    <button onclick="login()">Login</button>
    <p>No account? <a href="#" onclick="show('signup')">Sign Up</a></p>
  </div>

  <!-- SIGNUP PAGE -->
  <div id="signup" class="page">
    <h2>Sign Up</h2>
    <input type="email" id="signupEmail" placeholder="Email">
    <input type="password" id="signupPass" placeholder="Password">
    <input type="text" id="signupUsername" placeholder="Username (optional)">
    <button onclick="signup()">Sign Up</button>
    <p>Already have account? <a href="#" onclick="show('login')">Login</a></p>
  </div>

  <!-- HOME FEED -->
  <div id="home" class="page">
    <h2>Global Feed</h2>
    <div id="posts">
      <div class="loading"></div>
    </div>
  </div>

  <!-- CREATE POST -->
  <div id="post" class="page">
    <h2>Create Post</h2>
    <input id="title" placeholder="Title">
    <div class="custom-file-input">
      <input type="file" id="file" accept="image/*,video/*">
      <label class="file-input-label" for="file">üìÅ Choose file or drag and drop</label>
    </div>
    <button onclick="publish()">Publish</button>
  </div>

  <!-- MESSAGING PAGE -->
  <div id="messaging" class="page">
    <h2>Private Messaging</h2>
    
    <div class="add-friend-section">
      <h3>Add Friend</h3>
      <div class="add-friend-form">
        <input type="email" id="friendEmail" placeholder="Enter user's email">
        <button onclick="sendFriendRequest()">Send Friend Request</button>
      </div>
      <p style="margin-top: 10px; color: #ff9999; font-size: 14px;">
        Tip: You can also click on any user's name in posts to add them as a friend!
      </p>
    </div>
    
    <div class="messaging-container">
      <!-- Friends List -->
      <div class="friends-sidebar">
        <h3>Your Friends</h3>
        <div class="friends-search">
          <input type="text" id="friendSearch" placeholder="Search friends..." onkeyup="filterFriends()">
        </div>
        <div class="friend-list" id="friendList">
          <div class="loading"></div>
        </div>
      </div>
      
      <!-- Chat Area -->
      <div class="chat-container">
        <div class="chat-header" id="chatHeader">
          <div class="chat-header-avatar" id="chatAvatar"></div>
          <div>
            <div id="chatName">Select a friend to message</div>
            <div id="chatStatus" class="friend-status offline">Click a friend to start chatting</div>
          </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
          <div style="text-align: center; color: #ff9999; padding: 20px;">
            Select a friend from the list to start messaging
          </div>
        </div>
        
        <div class="chat-input-area">
          <input type="text" id="messageInput" placeholder="Type your message..." disabled>
          <button onclick="sendMessage()" id="sendMessageBtn" disabled>Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FRIEND REQUESTS PAGE -->
  <div id="requests" class="page">
    <h2>Friend Requests</h2>
    
    <div class="requests-container">
      <h3>Pending Requests</h3>
      <div id="pendingRequests">
        <div class="loading"></div>
      </div>
      
      <h3 style="margin-top: 30px;">Sent Requests</h3>
      <div id="sentRequests">
        <div class="loading"></div>
      </div>
    </div>
  </div>
</div>

<script>
// FIREBASE INIT
firebase.initializeApp({
  apiKey: "AIzaSyDZYK8wRGXJNlGYNosolSo2zeEjLrqd4Eg",
  authDomain: "pastebin-604ee.firebaseapp.com",
  projectId: "pastebin-604ee",
  storageBucket: "pastebin-604ee.appspot.com"
});

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// Variables for media modal
let currentMediaUrl = '';
let currentMediaType = '';

// User profile data
let userProfile = {
  username: '',
  bio: '',
  avatar: '',
  themeColor: '#8b0000',
  postCount: 0,
  joinDate: ''
};

// Default avatars
const defaultAvatars = [
  'https://api.dicebear.com/7.x/avataaars/svg?seed=blood1&backgroundColor=b6e3f4',
  'https://api.dicebear.com/7.x/avataaars/svg?seed=blood2&backgroundColor=b6e3f4',
  'https://api.dicebear.com/7.x/avataaars/svg?seed=blood3&backgroundColor=b6e3f4',
  'https://api.dicebear.com/7.x/avataaars/svg?seed=blood4&backgroundColor=b6e3f4',
  'https://api.dicebear.com/7.x/avataaars/svg?seed=blood5&backgroundColor=b6e3f4',
  'https://api.dicebear.com/7.x/avataaars/svg?seed=blood6&backgroundColor=b6e3f4'
];

// Uploaded avatar file
let uploadedAvatarFile = null;
let uploadedAvatarUrl = '';

// Messaging variables
let currentChatFriend = null;
let friends = [];
let pendingRequests = [];
let sentRequests = [];
let messages = {};

// Post editing variables
let postToEdit = null;

// THEME MANAGEMENT
let isBloodyRedTheme = true;

function toggleTheme() {
  const body = document.body;
  const toggleBtn = document.getElementById('themeToggle');
  
  if (isBloodyRedTheme) {
    body.classList.remove('bloody-red-theme');
    body.classList.add('normal-theme');
    toggleBtn.textContent = 'Switch to Bloody Red Theme';
  } else {
    body.classList.remove('normal-theme');
    body.classList.add('bloody-red-theme');
    toggleBtn.textContent = 'Switch to Normal Theme';
  }
  
  isBloodyRedTheme = !isBloodyRedTheme;
  localStorage.setItem('theme', isBloodyRedTheme ? 'bloody-red' : 'normal');
}

// Load saved theme
window.addEventListener('DOMContentLoaded', () => {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'normal') {
    toggleTheme(); // Switch to normal theme
  }
  loadAvatarOptions();
  setupDragAndDrop();
});

// Load avatar options
function loadAvatarOptions() {
  const container = document.getElementById('avatarOptions');
  container.innerHTML = '';
  
  defaultAvatars.forEach((avatar, index) => {
    const img = document.createElement('img');
    img.className = 'avatar-option';
    img.src = avatar;
    img.alt = `Avatar ${index + 1}`;
    img.onclick = () => selectDefaultAvatar(avatar, index);
    container.appendChild(img);
  });
}

// Setup drag and drop for avatar upload
function setupDragAndDrop() {
  const uploadArea = document.getElementById('avatarUploadArea');
  
  // Prevent default drag behaviors
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
  });
  
  // Highlight drop area when item is dragged over it
  ['dragenter', 'dragover'].forEach(eventName => {
    uploadArea.addEventListener(eventName, highlight, false);
  });
  
  ['dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, unhighlight, false);
  });
  
  // Handle dropped files
  uploadArea.addEventListener('drop', handleDrop, false);
  
  // File input for the upload area
  uploadArea.addEventListener('click', () => {
    document.getElementById('avatarUpload').click();
  });
}

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

function highlight() {
  document.getElementById('avatarUploadArea').classList.add('dragover');
}

function unhighlight() {
  document.getElementById('avatarUploadArea').classList.remove('dragover');
}

function handleDrop(e) {
  const dt = e.dataTransfer;
  const files = dt.files;
  
  if (files.length > 0) {
    handleAvatarUpload({ target: { files: files } });
  }
}

// Handle avatar upload from file input
function handleAvatarUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Validate file type
  if (!file.type.startsWith('image/')) {
    alert('Please upload an image file (PNG, JPG, GIF)');
    return;
  }
  
  // Validate file size (5MB limit)
  if (file.size > 5 * 1024 * 1024) {
    alert('File size too large. Maximum size is 5MB.');
    return;
  }
  
  uploadedAvatarFile = file;
  
  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    const preview = document.getElementById('avatarPreview');
    preview.src = e.target.result;
    
    // Clear default avatar selection
    document.querySelectorAll('.avatar-option').forEach(option => {
      option.classList.remove('selected');
    });
    
    // Clear custom URL
    document.getElementById('customAvatarUrl').value = '';
  };
  reader.readAsDataURL(file);
}

// Upload avatar to Firebase Storage
async function uploadAvatarToStorage(userId) {
  if (!uploadedAvatarFile) return null;
  
  const uploadProgress = document.getElementById('uploadProgress');
  const progressBar = document.getElementById('uploadProgressBar');
  const saveBtn = document.getElementById('saveProfileBtn');
  
  // Show progress bar
  uploadProgress.style.display = 'block';
  progressBar.style.width = '0%';
  saveBtn.disabled = true;
  saveBtn.textContent = 'Uploading...';
  
  try {
    // Create a unique filename
    const timestamp = Date.now();
    const fileExt = uploadedAvatarFile.name.split('.').pop();
    const filename = `avatars/${userId}_${timestamp}.${fileExt}`;
    
    // Upload to Firebase Storage
    const storageRef = storage.ref(filename);
    const uploadTask = storageRef.put(uploadedAvatarFile);
    
    // Monitor upload progress
    return new Promise((resolve, reject) => {
      uploadTask.on('state_changed',
        (snapshot) => {
          // Update progress bar
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          progressBar.style.width = `${progress}%`;
        },
        (error) => {
          // Hide progress bar on error
          uploadProgress.style.display = 'none';
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Profile';
          reject(error);
        },
        async () => {
          // Upload complete, get download URL
          const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
          
          // Hide progress bar
          uploadProgress.style.display = 'none';
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Profile';
          
          resolve(downloadURL);
        }
      );
    });
  } catch (error) {
    console.error('Upload error:', error);
    alert('Failed to upload avatar. Please try again.');
    return null;
  }
}

// Select default avatar
function selectDefaultAvatar(avatarUrl, index) {
  uploadedAvatarFile = null; // Clear uploaded file
  selectedAvatar = avatarUrl;
  document.getElementById('avatarPreview').src = avatarUrl;
  
  // Update selection
  document.querySelectorAll('.avatar-option').forEach((option, i) => {
    option.classList.remove('selected');
    if (i === index) {
      option.classList.add('selected');
    }
  });
  
  // Clear custom URL
  document.getElementById('customAvatarUrl').value = '';
}

// MEDIA MODAL FUNCTIONS
function openMediaModal(mediaUrl, mediaType) {
  currentMediaUrl = mediaUrl;
  currentMediaType = mediaType;
  
  const modal = document.getElementById('mediaModal');
  const container = document.getElementById('modalMediaContainer');
  
  container.innerHTML = '';
  
  if (mediaType.startsWith('image')) {
    const img = document.createElement('img');
    img.src = mediaUrl;
    img.alt = 'Full preview';
    img.style.maxWidth = '100%';
    img.style.maxHeight = '95vh';
    img.style.objectFit = 'contain';
    container.appendChild(img);
  } else if (mediaType.startsWith('video')) {
    const video = document.createElement('video');
    video.src = mediaUrl;
    video.controls = true;
    video.autoplay = true;
    video.style.maxWidth = '100%';
    video.style.maxHeight = '95vh';
    video.style.objectFit = 'contain';
    container.appendChild(video);
  }
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeMediaModal() {
  const modal = document.getElementById('mediaModal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
  
  const video = modal.querySelector('video');
  if (video) {
    video.pause();
    video.currentTime = 0;
  }
}

function downloadMedia() {
  if (!currentMediaUrl) return;
  
  const link = document.createElement('a');
  link.href = currentMediaUrl;
  
  const timestamp = new Date().getTime();
  if (currentMediaType.startsWith('image')) {
    link.download = `image_${timestamp}.jpg`;
  } else if (currentMediaType.startsWith('video')) {
    link.download = `video_${timestamp}.mp4`;
  }
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// PROFILE MODAL FUNCTIONS
let selectedAvatar = '';
let selectedColor = '#8b0000';

function openProfileModal() {
  const modal = document.getElementById('profileModal');
  const user = auth.currentUser;
  
  if (!user) return;
  
  // Reset upload state
  uploadedAvatarFile = null;
  const uploadProgress = document.getElementById('uploadProgress');
  uploadProgress.style.display = 'none';
  
  // Load current profile data
  loadUserProfile(user.uid).then(profile => {
    document.getElementById('profileUsername').value = profile.username || user.email.split('@')[0];
    document.getElementById('profileBio').value = profile.bio || '';
    document.getElementById('customAvatarUrl').value = '';
    document.getElementById('avatarPreview').src = profile.avatar || defaultAvatars[0];
    
    // Set selected avatar
    selectedAvatar = profile.avatar || defaultAvatars[0];
    selectedColor = profile.themeColor || '#8b0000';
    
    // Update color picker
    document.querySelectorAll('.color-option').forEach(option => {
      option.classList.remove('selected');
      if (option.style.backgroundColor === selectedColor || 
          option.style.backgroundColor === rgbToHex(selectedColor)) {
        option.classList.add('selected');
      }
    });
    
    // Update avatar selection if it's a default avatar
    document.querySelectorAll('.avatar-option').forEach((option, index) => {
      option.classList.remove('selected');
      if (option.src === selectedAvatar) {
        option.classList.add('selected');
      }
    });
    
    // Enable save button
    const saveBtn = document.getElementById('saveProfileBtn');
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Profile';
  });
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeProfileModal() {
  const modal = document.getElementById('profileModal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
}

function selectColor(color) {
  selectedColor = color;
  
  // Update selection
  document.querySelectorAll('.color-option').forEach(option => {
    option.classList.remove('selected');
    if (option.style.backgroundColor === color || 
        option.style.backgroundColor === rgbToHex(color)) {
      option.classList.add('selected');
    }
  });
}

function rgbToHex(rgb) {
  if (rgb.startsWith('#')) return rgb;
  
  const rgbMatch = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
  if (rgbMatch) {
    return "#" + ((1 << 24) + (parseInt(rgbMatch[1]) << 16) + (parseInt(rgbMatch[2]) << 8) + parseInt(rgbMatch[3])).toString(16).slice(1);
  }
  return rgb;
}

async function saveProfile() {
  const user = auth.currentUser;
  if (!user) return;
  
  const username = document.getElementById('profileUsername').value.trim();
  const bio = document.getElementById('profileBio').value.trim();
  const customAvatarUrl = document.getElementById('customAvatarUrl').value.trim();
  
  let avatarUrl = '';
  
  // Determine which avatar to use (priority: uploaded file > custom URL > selected default > current)
  if (uploadedAvatarFile) {
    // Upload new avatar to Firebase Storage
    avatarUrl = await uploadAvatarToStorage(user.uid);
    if (!avatarUrl) {
      alert('Failed to upload avatar. Please try again.');
      return;
    }
  } else if (customAvatarUrl) {
    // Use custom URL
    avatarUrl = customAvatarUrl;
  } else if (selectedAvatar) {
    // Use selected default avatar
    avatarUrl = selectedAvatar;
  } else {
    // Keep current avatar
    avatarUrl = userProfile.avatar;
  }
  
  // Update user profile in Firestore
  await db.collection('profiles').doc(user.uid).set({
    username: username || user.email.split('@')[0],
    bio: bio,
    avatar: avatarUrl,
    themeColor: selectedColor,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
  
  // Update local profile
  userProfile.username = username;
  userProfile.bio = bio;
  userProfile.avatar = avatarUrl;
  userProfile.themeColor = selectedColor;
  
  // Update UI
  updateProfileDisplay();
  
  closeProfileModal();
  alert('Profile saved successfully!');
  
  // Reset upload state
  uploadedAvatarFile = null;
}

// Load user profile from Firestore
async function loadUserProfile(uid) {
  const doc = await db.collection('profiles').doc(uid).get();
  if (doc.exists) {
    userProfile = { ...userProfile, ...doc.data() };
  } else {
    // Create default profile
    const user = auth.currentUser;
    userProfile.username = user.email.split('@')[0];
    userProfile.avatar = defaultAvatars[Math.floor(Math.random() * defaultAvatars.length)];
    userProfile.themeColor = '#8b0000';
    userProfile.joinDate = new Date().toLocaleDateString();
    
    // Save to Firestore
    await db.collection('profiles').doc(uid).set(userProfile);
  }
  
  // Load post count
  const posts = await db.collection('posts')
    .where('author', '==', user.email)
    .get();
  userProfile.postCount = posts.size;
  
  return userProfile;
}

// Update profile display
function updateProfileDisplay() {
  const user = auth.currentUser;
  if (!user) return;
  
  const profileDisplay = document.getElementById('profileDisplay');
  
  profileDisplay.innerHTML = `
    <div class="profile-section">
      <img src="${userProfile.avatar}" alt="Avatar" class="profile-avatar" onclick="openProfileModal()">
      <div class="profile-info">
        <div class="profile-username">${userProfile.username}</div>
        <div class="profile-bio">${userProfile.bio || 'No bio yet.'}</div>
        <div class="profile-stats">
          <div class="stat">
            <span class="stat-value">${userProfile.postCount || 0}</span>
            <span>Posts</span>
          </div>
          <div class="stat">
            <span class="stat-value">${userProfile.joinDate || new Date().toLocaleDateString()}</span>
            <span>Joined</span>
          </div>
          <div class="stat">
            <span class="stat-value">${friends.length}</span>
            <span>Friends</span>
          </div>
        </div>
      </div>
    </div>
  `;
}

// FRIEND SYSTEM FUNCTIONS

// Send friend request
async function sendFriendRequest(email = null) {
  const user = auth.currentUser;
  if (!user) return alert('Please login first');
  
  const friendEmail = email || document.getElementById('friendEmail').value.trim();
  if (!friendEmail) return alert('Please enter an email address');
  
  if (friendEmail === user.email) return alert('You cannot add yourself as a friend');
  
  // Check if user exists
  try {
    // Check if friend exists (we can't query by email directly, so we'll check profiles)
    const profilesSnapshot = await db.collection('profiles')
      .where('username', '==', friendEmail.split('@')[0])
      .get();
    
    if (profilesSnapshot.empty) {
      // Also check by email pattern in username field
      const allProfiles = await db.collection('profiles').get();
      let friendExists = false;
      
      allProfiles.forEach(doc => {
        const profile = doc.data();
        if (profile.username === friendEmail || profile.email === friendEmail) {
          friendExists = true;
        }
      });
      
      if (!friendExists) {
        alert('User not found. Please check the email and try again.');
        return;
      }
    }
    
    // Check if already friends
    const friendshipCheck = await db.collection('friendships')
      .where('user1', 'in', [user.email, friendEmail])
      .where('user2', 'in', [user.email, friendEmail])
      .get();
    
    if (!friendshipCheck.empty) {
      alert('You are already friends or have a pending request with this user');
      return;
    }
    
    // Check if request already exists
    const requestCheck = await db.collection('friend_requests')
      .where('from', '==', user.email)
      .where('to', '==', friendEmail)
      .where('status', '==', 'pending')
      .get();
    
    if (!requestCheck.empty) {
      alert('Friend request already sent');
      return;
    }
    
    // Create friend request
    await db.collection('friend_requests').add({
      from: user.email,
      fromUsername: userProfile.username,
      fromAvatar: userProfile.avatar,
      to: friendEmail,
      status: 'pending',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    alert('Friend request sent!');
    document.getElementById('friendEmail').value = '';
    
    // Refresh requests
    loadFriendRequests();
  } catch (error) {
    console.error('Error sending friend request:', error);
    alert('Error sending friend request. Please try again.');
  }
}

// Load friend requests
async function loadFriendRequests() {
  const user = auth.currentUser;
  if (!user) return;
  
  try {
    // Load pending requests (to me)
    const pendingSnapshot = await db.collection('friend_requests')
      .where('to', '==', user.email)
      .where('status', '==', 'pending')
      .orderBy('createdAt', 'desc')
      .get();
    
    pendingRequests = [];
    pendingSnapshot.forEach(doc => {
      pendingRequests.push({ id: doc.id, ...doc.data() });
    });
    
    // Load sent requests (from me)
    const sentSnapshot = await db.collection('friend_requests')
      .where('from', '==', user.email)
      .where('status', '==', 'pending')
      .orderBy('createdAt', 'desc')
      .get();
    
    sentRequests = [];
    sentSnapshot.forEach(doc => {
      sentRequests.push({ id: doc.id, ...doc.data() });
    });
    
    // Update UI
    updateRequestsUI();
    
    // Update badge
    updateNotificationBadges();
  } catch (error) {
    console.error('Error loading friend requests:', error);
  }
}

// Update requests UI
function updateRequestsUI() {
  const pendingContainer = document.getElementById('pendingRequests');
  const sentContainer = document.getElementById('sentRequests');
  
  // Pending requests
  if (pendingRequests.length === 0) {
    pendingContainer.innerHTML = '<p style="color: #ff9999; text-align: center;">No pending requests</p>';
  } else {
    pendingContainer.innerHTML = pendingRequests.map(request => `
      <div class="request-item">
        <div class="request-user">
          <img src="${request.fromAvatar || defaultAvatars[0]}" alt="Avatar" class="friend-avatar">
          <div>
            <div class="friend-name">${request.fromUsername || request.from.split('@')[0]}</div>
            <div class="friend-status">${request.from}</div>
          </div>
        </div>
        <div class="request-actions">
          <button class="request-btn accept" onclick="handleFriendRequest('${request.id}', 'accept')">Accept</button>
          <button class="request-btn reject" onclick="handleFriendRequest('${request.id}', 'reject')">Reject</button>
        </div>
      </div>
    `).join('');
  }
  
  // Sent requests
  if (sentRequests.length === 0) {
    sentContainer.innerHTML = '<p style="color: #ff9999; text-align: center;">No sent requests</p>';
  } else {
    sentContainer.innerHTML = sentRequests.map(request => `
      <div class="request-item">
        <div class="request-user">
          <img src="${defaultAvatars[0]}" alt="Avatar" class="friend-avatar">
          <div>
            <div class="friend-name">${request.to.split('@')[0]}</div>
            <div class="friend-status">${request.to}</div>
          </div>
        </div>
        <div class="request-actions">
          <button class="request-btn reject" onclick="cancelFriendRequest('${request.id}')">Cancel</button>
        </div>
      </div>
    `).join('');
  }
}

// Handle friend request (accept/reject)
async function handleFriendRequest(requestId, action) {
  try {
    const requestRef = db.collection('friend_requests').doc(requestId);
    const requestDoc = await requestRef.get();
    
    if (!requestDoc.exists) {
      alert('Request not found');
      return;
    }
    
    const request = requestDoc.data();
    
    if (action === 'accept') {
      // Create friendship
      await db.collection('friendships').add({
        user1: request.from,
        user2: request.to,
        user1Username: request.fromUsername,
        user2Username: userProfile.username,
        user1Avatar: request.fromAvatar,
        user2Avatar: userProfile.avatar,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Update request status
      await requestRef.update({ status: 'accepted' });
      
      alert('Friend request accepted!');
      
      // Send welcome message
      await db.collection('messages').add({
        from: user.email,
        to: request.from,
        message: `Hi! I've accepted your friend request. Let's chat!`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        read: false
      });
    } else {
      // Reject request
      await requestRef.update({ status: 'rejected' });
      alert('Friend request rejected');
    }
    
    // Refresh requests and friends list
    loadFriendRequests();
    loadFriends();
  } catch (error) {
    console.error('Error handling friend request:', error);
    alert('Error processing request. Please try again.');
  }
}

// Cancel friend request
async function cancelFriendRequest(requestId) {
  if (!confirm('Cancel this friend request?')) return;
  
  try {
    await db.collection('friend_requests').doc(requestId).delete();
    loadFriendRequests();
    alert('Friend request cancelled');
  } catch (error) {
    console.error('Error cancelling friend request:', error);
    alert('Error cancelling request. Please try again.');
  }
}

// Load friends list
async function loadFriends() {
  const user = auth.currentUser;
  if (!user) return;
  
  try {
    const friendshipsSnapshot = await db.collection('friendships')
      .where('user1', '==', user.email)
      .get();
    
    const friendshipsSnapshot2 = await db.collection('friendships')
      .where('user2', '==', user.email)
      .get();
    
    friends = [];
    
    // Add friends from user1 side
    friendshipsSnapshot.forEach(doc => {
      const friendship = doc.data();
      friends.push({
        email: friendship.user2,
        username: friendship.user2Username || friendship.user2.split('@')[0],
        avatar: friendship.user2Avatar || defaultAvatars[0],
        friendshipId: doc.id
      });
    });
    
    // Add friends from user2 side
    friendshipsSnapshot2.forEach(doc => {
      const friendship = doc.data();
      friends.push({
        email: friendship.user1,
        username: friendship.user1Username || friendship.user1.split('@')[0],
        avatar: friendship.user1Avatar || defaultAvatars[0],
        friendshipId: doc.id
      });
    });
    
    // Remove duplicates
    friends = friends.filter((friend, index, self) =>
      index === self.findIndex(f => f.email === friend.email)
    );
    
    updateFriendsUI();
  } catch (error) {
    console.error('Error loading friends:', error);
  }
}

// Update friends UI
function updateFriendsUI() {
  const friendList = document.getElementById('friendList');
  
  if (friends.length === 0) {
    friendList.innerHTML = `
      <div style="text-align: center; color: #ff9999; padding: 20px;">
        <p>No friends yet</p>
        <p style="font-size: 12px;">Add friends to start messaging!</p>
      </div>
    `;
  } else {
    friendList.innerHTML = friends.map(friend => `
      <div class="friend-item" onclick="openChat('${friend.email}', '${friend.username}', '${friend.avatar}')">
        <img src="${friend.avatar}" alt="Avatar" class="friend-avatar">
        <div class="friend-info">
          <div class="friend-name">${friend.username}</div>
          <div class="friend-status online">Click to message</div>
        </div>
      </div>
    `).join('');
  }
}

// Filter friends
function filterFriends() {
  const searchTerm = document.getElementById('friendSearch').value.toLowerCase();
  const friendItems = document.querySelectorAll('.friend-item');
  
  friendItems.forEach(item => {
    const friendName = item.querySelector('.friend-name').textContent.toLowerCase();
    if (friendName.includes(searchTerm)) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
}

// MESSAGING FUNCTIONS

// Open chat with friend
function openChat(friendEmail, friendName, friendAvatar) {
  currentChatFriend = { email: friendEmail, name: friendName, avatar: friendAvatar };
  
  // Update chat header
  document.getElementById('chatAvatar').innerHTML = `<img src="${friendAvatar}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%;">`;
  document.getElementById('chatName').textContent = friendName;
  document.getElementById('chatStatus').textContent = 'Online';
  document.getElementById('chatStatus').className = 'friend-status online';
  
  // Enable message input
  document.getElementById('messageInput').disabled = false;
  document.getElementById('sendMessageBtn').disabled = false;
  document.getElementById('messageInput').placeholder = `Message ${friendName}...`;
  document.getElementById('messageInput').focus();
  
  // Load messages
  loadMessages(friendEmail);
}

// Load messages with friend
async function loadMessages(friendEmail) {
  const user = auth.currentUser;
  if (!user) return;
  
  const messagesContainer = document.getElementById('chatMessages');
  messagesContainer.innerHTML = '<div class="loading"></div>';
  
  try {
    // Load messages where user is sender and friend is receiver
    const sentMessagesSnapshot = await db.collection('messages')
      .where('from', '==', user.email)
      .where('to', '==', friendEmail)
      .orderBy('timestamp', 'asc')
      .get();
    
    // Load messages where friend is sender and user is receiver
    const receivedMessagesSnapshot = await db.collection('messages')
      .where('from', '==', friendEmail)
      .where('to', '==', user.email)
      .orderBy('timestamp', 'asc')
      .get();
    
    // Combine and sort all messages
    const allMessages = [];
    
    sentMessagesSnapshot.forEach(doc => {
      allMessages.push({ id: doc.id, ...doc.data(), type: 'sent' });
    });
    
    receivedMessagesSnapshot.forEach(doc => {
      allMessages.push({ id: doc.id, ...doc.data(), type: 'received' });
    });
    
    // Sort by timestamp
    allMessages.sort((a, b) => {
      return a.timestamp?.seconds - b.timestamp?.seconds || 0;
    });
    
    // Update UI
    if (allMessages.length === 0) {
      messagesContainer.innerHTML = `
        <div style="text-align: center; color: #ff9999; padding: 20px;">
          <p>No messages yet</p>
          <p style="font-size: 12px;">Send a message to start the conversation!</p>
        </div>
      `;
    } else {
      messagesContainer.innerHTML = allMessages.map(msg => {
        const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Just now';
        
        return `
          <div class="message ${msg.type}">
            <div>${msg.message}</div>
            <div class="message-time">${time}</div>
          </div>
        `;
      }).join('');
      
      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Mark messages as read
    receivedMessagesSnapshot.forEach(async doc => {
      if (!doc.data().read) {
        await db.collection('messages').doc(doc.id).update({ read: true });
      }
    });
    
    // Store messages
    messages[friendEmail] = allMessages;
  } catch (error) {
    console.error('Error loading messages:', error);
    messagesContainer.innerHTML = '<div style="color: #ff6666; text-align: center;">Error loading messages</div>';
  }
}

// Send message
async function sendMessage() {
  const user = auth.currentUser;
  if (!user || !currentChatFriend) return;
  
  const messageInput = document.getElementById('messageInput');
  const message = messageInput.value.trim();
  
  if (!message) return;
  
  try {
    // Send message
    await db.collection('messages').add({
      from: user.email,
      to: currentChatFriend.email,
      message: message,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false
    });
    
    // Clear input
    messageInput.value = '';
    
    // Reload messages
    loadMessages(currentChatFriend.email);
  } catch (error) {
    console.error('Error sending message:', error);
    alert('Error sending message. Please try again.');
  }
}

// Send message on Enter key
document.getElementById('messageInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Update notification badges
function updateNotificationBadges() {
  const messageBadge = document.getElementById('messageBadge');
  const requestBadge = document.getElementById('requestBadge');
  
  // Update request badge
  if (pendingRequests.length > 0) {
    requestBadge.textContent = pendingRequests.length;
    requestBadge.style.display = 'flex';
  } else {
    requestBadge.style.display = 'none';
  }
  
  // Note: For message badge, we'd need to track unread messages
  // This is a simplified version
  messageBadge.style.display = 'none';
}

// POST EDITING FUNCTIONS

// Open edit modal
function openEditModal(postId, postData) {
  postToEdit = { id: postId, ...postData };
  
  const modal = document.getElementById('editModal');
  const editTitle = document.getElementById('editTitle');
  const preview = document.getElementById('currentMediaPreview');
  
  // Set current values
  editTitle.value = postData.title;
  
  // Show current media
  preview.innerHTML = '';
  if (postData.media) {
    if (postData.type.startsWith('image')) {
      preview.innerHTML = `<img src="${postData.media}" style="max-width: 100%; border-radius: 5px; margin: 10px 0;">`;
    } else {
      preview.innerHTML = `<video src="${postData.media}" controls style="max-width: 100%; border-radius: 5px; margin: 10px 0;"></video>`;
    }
  }
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// Close edit modal
function closeEditModal() {
  const modal = document.getElementById('editModal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
  postToEdit = null;
}

// Update post
async function updatePost() {
  if (!postToEdit) return;
  
  const newTitle = document.getElementById('editTitle').value.trim();
  const newFile = document.getElementById('editFile').files[0];
  
  if (!newTitle) return alert('Title is required');
  
  try {
    let mediaUrl = postToEdit.media;
    let mediaType = postToEdit.type;
    
    // If new file is selected, upload it
    if (newFile) {
      if (!newFile.type.startsWith("image/") && !newFile.type.startsWith("video/")) {
        return alert("Media only");
      }
      
      // Convert to base64
      const reader = new FileReader();
      await new Promise((resolve) => {
        reader.onload = () => {
          mediaUrl = reader.result;
          mediaType = newFile.type;
          resolve();
        };
        reader.readAsDataURL(newFile);
      });
    }
    
    // Update post in Firestore
    await db.collection('posts').doc(postToEdit.id).update({
      title: newTitle,
      media: mediaUrl,
      type: mediaType,
      editedAt: firebase.firestore.FieldValue.serverTimestamp(),
      edited: true
    });
    
    closeEditModal();
    alert('Post updated successfully!');
    loadPosts(); // Refresh posts
  } catch (error) {
    console.error('Error updating post:', error);
    alert('Error updating post. Please try again.');
  }
}

// Check friend status for a user
async function checkFriendStatus(email) {
  const user = auth.currentUser;
  if (!user || user.email === email) return 'self';
  
  // Check if already friends
  const friendshipCheck = await db.collection('friendships')
    .where('user1', 'in', [user.email, email])
    .where('user2', 'in', [user.email, email])
    .get();
  
  if (!friendshipCheck.empty) return 'friend';
  
  // Check if request sent
  const requestCheck = await db.collection('friend_requests')
    .where('from', '==', user.email)
    .where('to', '==', email)
    .where('status', '==', 'pending')
    .get();
  
  if (!requestCheck.empty) return 'pending';
  
  // Check if request received
  const receivedCheck = await db.collection('friend_requests')
    .where('from', '==', email)
    .where('to', '==', user.email)
    .where('status', '==', 'pending')
    .get();
  
  if (!receivedCheck.empty) return 'received';
  
  return 'none';
}

// SHOW PAGE FUNCTION
function show(id){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.getElementById(id).style.display='block';
  
  if (id === 'home') {
    loadPosts();
  } else if (id === 'profile') {
    updateProfileDisplay();
  } else if (id === 'messaging') {
    loadFriends();
    document.getElementById('messageInput').focus();
  } else if (id === 'requests') {
    loadFriendRequests();
  }
}

// AUTH STATE
auth.onAuthStateChanged(async user=>{
  if(user){
    document.getElementById('userEmail').textContent = user.email + (user.email === 'exoticslash3r@gmail.com' ? ' (AndreKriegman)' : '');
    document.getElementById('logoutBtn').style.display='inline-block';
    document.getElementById('profileBtn').style.display='inline-block';
    document.getElementById('messagingBtn').style.display='inline-block';
    document.getElementById('requestsBtn').style.display='inline-block';
    
    // Load user profile
    await loadUserProfile(user.uid);
    
    // Load friends and requests
    loadFriends();
    loadFriendRequests();
    
    // Set up real-time listeners
    setupRealtimeListeners();
    
    show('home');
    loadPosts();
  } else {
    document.getElementById('userEmail').textContent='Not signed in';
    document.getElementById('logoutBtn').style.display='none';
    document.getElementById('profileBtn').style.display='none';
    document.getElementById('messagingBtn').style.display='none';
    document.getElementById('requestsBtn').style.display='none';
    show('login');
  }
});

// Set up real-time listeners
function setupRealtimeListeners() {
  const user = auth.currentUser;
  if (!user) return;
  
  // Listen for new messages
  db.collection('messages')
    .where('to', '==', user.email)
    .where('read', '==', false)
    .onSnapshot((snapshot) => {
      if (snapshot.size > 0) {
        const badge = document.getElementById('messageBadge');
        badge.textContent = snapshot.size;
        badge.style.display = 'flex';
      }
    });
  
  // Listen for new friend requests
  db.collection('friend_requests')
    .where('to', '==', user.email)
    .where('status', '==', 'pending')
    .onSnapshot((snapshot) => {
      loadFriendRequests();
    });
  
  // Listen for new messages in current chat
  if (currentChatFriend) {
    db.collection('messages')
      .where('from', '==', currentChatFriend.email)
      .where('to', '==', user.email)
      .onSnapshot((snapshot) => {
        if (currentChatFriend) {
          loadMessages(currentChatFriend.email);
        }
      });
  }
}

// SIGNUP / LOGIN
async function signup(){
  const email = document.getElementById('signupEmail').value;
  const pass = document.getElementById('signupPass').value;
  const username = document.getElementById('signupUsername').value.trim();
  
  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
    const user = userCredential.user;
    
    // Create profile for new user
    await db.collection('profiles').doc(user.uid).set({
      username: username || email.split('@')[0],
      bio: '',
      avatar: defaultAvatars[Math.floor(Math.random() * defaultAvatars.length)],
      themeColor: '#8b0000',
      joinDate: new Date().toLocaleDateString(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    alert('Account created successfully!');
  } catch(e) {
    alert(e.message);
  }
}

function login(){
  const email=document.getElementById('loginEmail').value;
  const pass=document.getElementById('loginPass').value;
  auth.signInWithEmailAndPassword(email,pass)
  .then(() => {
    alert('Logged in successfully!');
  })
  .catch(e=>alert(e.message));
}

function logout(){ 
  if(confirm("Are you sure you want to logout?")) {
    auth.signOut();
  }
}

// CREATE POST
function publish(){
  const user=auth.currentUser;
  if(!user) return alert("Login first");
  const t=document.getElementById('title').value.trim();
  const f=document.getElementById('file').files[0];
  if(!t||!f) return alert("Missing data");
  if(!f.type.startsWith("image/")&&!f.type.startsWith("video/")) return alert("Media only");

  // Show loading
  const publishBtn = document.querySelector('#post button');
  const originalText = publishBtn.textContent;
  publishBtn.textContent = 'Uploading...';
  publishBtn.disabled = true;

  const r=new FileReader();
  r.onload=()=>{
    db.collection("posts").add({
      title:t,
      media:r.result,
      type:f.type,
      author:user.email,
      authorUsername: userProfile.username || user.email.split('@')[0],
      authorAvatar: userProfile.avatar || defaultAvatars[0],
      time:firebase.firestore.FieldValue.serverTimestamp(),
      edited: false
    }).then(() => {
      document.getElementById('title').value=""; 
      document.getElementById('file').value="";
      document.querySelector('.file-input-label').textContent = 'üìÅ Choose file or drag and drop';
      alert('Post published successfully!');
      show('home');
    }).catch(e => {
      alert('Error: ' + e.message);
    }).finally(() => {
      publishBtn.textContent = originalText;
      publishBtn.disabled = false;
    });
  };
  r.readAsDataURL(f);
}

// Update file input label
document.getElementById('file').addEventListener('change', function(e) {
  const label = document.querySelector('.file-input-label');
  if (this.files.length > 0) {
    label.textContent = `üìÅ Selected: ${this.files[0].name}`;
  } else {
    label.textContent = 'üìÅ Choose file or drag and drop';
  }
});

// Update edit file input label
document.getElementById('editFile').addEventListener('change', function(e) {
  const label = document.querySelector('.file-input-label[for="editFile"]');
  if (this.files.length > 0) {
    label.textContent = `üìÅ Selected: ${this.files[0].name}`;
  } else {
    label.textContent = 'üìÅ Choose new file (optional)';
  }
});

// LOAD POSTS with friend buttons
async function loadPosts(){
  const postsContainer = document.getElementById('posts');
  postsContainer.innerHTML = '<div class="loading"></div>';
  
  db.collection("posts").orderBy("time","desc").onSnapshot(async s=>{
    if(s.empty){
      postsContainer.innerHTML='<p style="text-align:center;padding:40px;color:#ff9999;">No posts yet. Be the first to post!</p>';
      return;
    }
    
    postsContainer.innerHTML="";
    
    // Get all posts and load profiles
    const posts = [];
    s.forEach(d => posts.push({ id: d.id, data: d.data() }));
    
    // Load profiles for all authors
    for (const post of posts) {
      const p = post.data;
      const div = document.createElement("div");
      div.className = 'post';
      
      // Format timestamp
      const time = p.time ? new Date(p.time.seconds * 1000).toLocaleString() : 'Just now';
      
      // Check if author is exoticslash3r@gmail.com
      const isAndre = p.author === 'exoticslash3r@gmail.com';
      const tagClass = isAndre ? 'tag andre-tag' : 'tag regular-tag';
      const tagText = isAndre ? 'AndreKriegman' : (p.authorUsername || p.author.split('@')[0]);
      
      // Get avatar (try from post data, then load from profile)
      let avatar = p.authorAvatar || defaultAvatars[0];
      
      // Check if post was edited
      const editedBadge = p.edited ? '<span style="color: #ff9999; font-size: 10px; margin-left: 5px;">(edited)</span>' : '';
      
      div.innerHTML=`
        <div class="post-header">
          <div class="post-user-info" onclick="handleUserClick('${p.author}', '${p.authorUsername || p.author.split('@')[0]}', '${avatar}')">
            <img src="${avatar}" alt="Avatar" class="post-avatar">
            <div>
              <div class="post-username">${p.authorUsername || p.author.split('@')[0]}</div>
              <div class="post-time">${time} ${editedBadge}</div>
            </div>
          </div>
          <span class="${tagClass}">${tagText}</span>
        </div>
        <strong>${p.title}</strong>
      `;
      
      // Add friend button (check status)
      const friendStatus = await checkFriendStatus(p.author);
      const friendActions = document.createElement('div');
      friendActions.className = 'friend-actions';
      
      if (friendStatus === 'none' && p.author !== auth.currentUser?.email) {
        const addBtn = document.createElement('button');
        addBtn.className = 'friend-btn';
        addBtn.textContent = 'Add Friend';
        addBtn.onclick = (e) => {
          e.stopPropagation();
          sendFriendRequest(p.author);
        };
        friendActions.appendChild(addBtn);
      } else if (friendStatus === 'pending') {
        const pendingBtn = document.createElement('button');
        pendingBtn.className = 'friend-btn pending';
        pendingBtn.textContent = 'Request Sent';
        pendingBtn.disabled = true;
        friendActions.appendChild(pendingBtn);
      } else if (friendStatus === 'friend') {
        const friendBtn = document.createElement('button');
        friendBtn.className = 'friend-btn added';
        friendBtn.textContent = 'Friends ‚úì';
        friendBtn.onclick = (e) => {
          e.stopPropagation();
          openChat(p.author, p.authorUsername || p.author.split('@')[0], avatar);
          show('messaging');
        };
        friendActions.appendChild(friendBtn);
      }
      
      div.appendChild(friendActions);
      
      if(p.media){
        if(p.type.startsWith("image")){
          const img = document.createElement('img');
          img.src = p.media;
          img.alt = p.title;
          img.className = 'media-preview';
          img.loading = 'lazy';
          img.style.cursor = 'zoom-in';
          img.onclick = () => openMediaModal(p.media, p.type);
          div.appendChild(img);
        }else{
          const video = document.createElement('video');
          video.src = p.media;
          video.controls = true;
          video.className = 'media-preview';
          video.style.cursor = 'pointer';
          video.onclick = () => openMediaModal(p.media, p.type);
          div.appendChild(video);
        }
      }
      
      // EDIT BUTTON IF OWNER
      const currentUser = auth.currentUser;
      if (currentUser && currentUser.email === p.author) {
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.className = 'edit-post-btn';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          openEditModal(post.id, p);
        };
        div.appendChild(editBtn);
      }
      
      // DELETE BUTTON IF OWNER OR ADMIN
      if (currentUser && (currentUser.email === p.author || currentUser.email === 'exoticslash3r@gmail.com')) {
        const del = document.createElement('button');
        del.textContent = 'Delete';
        del.className = 'delete';
        del.onclick = (e) => {
          e.stopPropagation();
          if (confirm('Delete this post?')) {
            db.collection('posts').doc(post.id).delete();
          }
        };
        div.appendChild(del);
      }
      
      postsContainer.appendChild(div);
    }
  }, error => {
    postsContainer.innerHTML='<p style="text-align:center;padding:40px;color:#ff6666;">Error loading posts. Please try again.</p>';
    console.error('Error loading posts:', error);
  });
}

// Handle user click (for adding friend from post)
function handleUserClick(email, username, avatar) {
  const user = auth.currentUser;
  if (!user || user.email === email) return;
  
  // Check if already friends or request sent
  checkFriendStatus(email).then(status => {
    if (status === 'none') {
      if (confirm(`Add ${username} as a friend?`)) {
        sendFriendRequest(email);
      }
    } else if (status === 'friend') {
      if (confirm(`Message ${username}?`)) {
        openChat(email, username, avatar);
        show('messaging');
      }
    } else if (status === 'pending') {
      alert(`Friend request already sent to ${username}`);
    } else if (status === 'received') {
      if (confirm(`You have a friend request from ${username}. Go to requests to accept?`)) {
        show('requests');
      }
    }
  });
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  show('login');
  
  // Close modals when clicking outside content
  document.getElementById('mediaModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeMediaModal();
    }
  });
  
  document.getElementById('profileModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeProfileModal();
    }
  });
  
  document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeEditModal();
    }
  });
  
  // Close modal with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeMediaModal();
      closeProfileModal();
      closeEditModal();
    }
  });
});
</script>

</body>
</html>
